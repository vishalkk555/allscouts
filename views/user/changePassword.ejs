<%- include("../partials/user/header") %>

<body class="change-password-body">
    <!-- Header -->
   

    <!-- Main Container -->
    <div class="change-password-container">
        <!-- Sidebar -->
        <aside class="change-password-sidebar">
            <ul class="change-password-sidebar-menu">
                <li><a href="/profile">Profile</a></li>
                <li><a href="/orders">Orders</a></li>
                <li><a href="/addresses">Addresses</a></li>
                <li><a href="/wallet">Wallet</a></li>
                <li><a href="/change-password" class="change-password-active">Change Password</a></li>
            </ul>
            <div class="change-password-logout-section">
                <button class="change-password-logout-btn" id="logoutBtn">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="change-password-main-content">
            <!-- <a href="/profile" class="change-password-back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                </svg>
                Back to Dashboard
            </a> -->

            <h1 class="change-password-page-title">Change Password</h1>
            <!-- <p class="change-password-page-subtitle">Update your account password</p> -->

            <!-- Form -->
            <form id="changePasswordForm" class="change-password-form">
                <div class="change-password-form-group">
                    <label for="currentPassword" class="change-password-form-label">Current Password</label>
                    <div class="change-password-input-container">
                        <input 
                            type="password" 
                            id="currentPassword" 
                            name="currentPassword" 
                            class="change-password-form-input"
                            placeholder="Enter your current password"
                            required
                        >
                        <button type="button" class="change-password-eye-btn" onclick="togglePasswordVisibility('currentPassword')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" id="eyeIcon-currentPassword">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="change-password-form-group">
                    <label for="newPassword" class="change-password-form-label">New Password</label>
                    <div class="change-password-input-container">
                        <input 
                            type="password" 
                            id="newPassword" 
                            name="newPassword" 
                            class="change-password-form-input"
                            placeholder="Enter your new password"
                            required
                        >
                        <button type="button" class="change-password-eye-btn" onclick="togglePasswordVisibility('newPassword')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" id="eyeIcon-newPassword">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="change-password-requirements">
                        <div class="change-password-requirement" id="req-length">
                            <div class="change-password-requirement-icon">✓</div>
                            At least 8 characters
                        </div>
                        <div class="change-password-requirement" id="req-uppercase">
                            <div class="change-password-requirement-icon">✓</div>
                            One uppercase letter
                        </div>
                        <div class="change-password-requirement" id="req-number">
                            <div class="change-password-requirement-icon">✓</div>
                            One number
                        </div>
                    </div>
                </div>

                <div class="change-password-form-group">
                    <label for="confirmPassword" class="change-password-form-label">Confirm New Password</label>
                    <div class="change-password-input-container">
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            name="confirmPassword" 
                            class="change-password-form-input"
                            placeholder="Confirm your new password"
                            required
                        >
                        <button type="button" class="change-password-eye-btn" onclick="togglePasswordVisibility('confirmPassword')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" id="eyeIcon-confirmPassword">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="change-password-form-actions">
                    <button type="submit" class="change-password-btn-update">
                        Update Password
                    </button>
                </div>
            </form>
        </main>
    </div>

    <script>

        
       document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
        // Send logout request
        const res = await fetch('/logout', { method: 'POST' });

        if (res.ok) {
            // Redirect to home page instead of login
            window.location.href = '/';
        } else {
            console.error('Logout failed');
        }
    } catch (error) {
        console.error('Error during logout:', error);
    }
});



        // Toggle password visibility
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const eyeIcon = document.getElementById(`eyeIcon-${inputId}`);
            
            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.innerHTML = `
                    <path d="M1.18 12C2.12 6.88 6.61 3 12 3s9.88 3.88 10.82 9c-.94 5.12-5.43 9-10.82 9S2.12 17.12 1.18 12zM12 17c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm0-8c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3z"/>
                    <path d="M1 1l22 22M9.9 4.24A9.12 9.12 0 0112 4c5.39 0 9.27 3.11 11 7.5a18.498 18.498 0 01-2.16 3.19M6.71 6.71a15.89 15.89 0 00-4.583 4.209C2.905 15.337 6.935 19 12 19a9.12 9.12 0 002.76-.24M14.12 14.12A3 3 0 119.88 9.88"/>
                `;
            } else {
                input.type = 'password';
                eyeIcon.innerHTML = `
                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                `;
            }
        }

        // Password validation
        function validatePassword(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                number: /\d/.test(password)
            };
            
            // Update requirement indicators
            updateRequirementIndicator('req-length', requirements.length);
            updateRequirementIndicator('req-uppercase', requirements.uppercase);
            updateRequirementIndicator('req-number', requirements.number);
            
            return requirements.length && requirements.uppercase && requirements.number;
        }

        function updateRequirementIndicator(reqId, isValid) {
            const element = document.getElementById(reqId);
            if (isValid) {
                element.classList.add('valid');
                element.classList.remove('invalid');
            } else {
                element.classList.add('invalid');
                element.classList.remove('valid');
            }
        }

        // Real-time password validation
        document.getElementById('newPassword').addEventListener('input', function(e) {
            validatePassword(e.target.value);
        });

        // Form submission
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            
            // Clear previous error styles
            document.querySelectorAll('.change-password-form-input').forEach(input => {
                input.classList.remove('change-password-error');
            });
            
            // Validation
            if (!currentPassword) {
                document.getElementById('currentPassword').classList.add('change-password-error');
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Current password is required!'
                });
                return;
            }
            
            if (!validatePassword(newPassword)) {
                document.getElementById('newPassword').classList.add('change-password-error');
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'New password must be at least 8 characters with 1 uppercase letter and 1 number!'
                });
                return;
            }
            
            if (newPassword !== confirmPassword) {
                document.getElementById('confirmPassword').classList.add('change-password-error');
                Swal.fire({
                    icon: 'error',
                    title: ' Error',
                    text: 'New password and confirm password do not match!'
                });
                return;
            }
            
            if (currentPassword === newPassword) {
                document.getElementById('newPassword').classList.add('change-password-error');
                Swal.fire({
                    icon: 'error',
                    title: ' Error',
                    text: 'New password must be different from current password!'
                });
                return;
            }
            
            // Confirmation dialog
            const result = await Swal.fire({
                title: 'Update Password?',
                text: 'Are you sure you want to update your password?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#1a1a1a',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, update it!'
            });
            
            if (result.isConfirmed) {
                // Show loading
                const loadingAlert = Swal.fire({
                    title: 'Updating Password...',
                    text: 'Please wait while we update your password.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                try {
                    // Submit form data
                    const response = await fetch('/changePassword', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            currentPassword,
                            newPassword,
                            confirmPassword
                        })
                    });
                    
                    const data = await response.json();
                    
                    loadingAlert.close();
                    
                    if (response.ok && data.success) {
                        await Swal.fire({
                            icon: 'success',
                            title: 'Password Updated!',
                            text: 'Your password has been updated successfully.',
                            confirmButtonColor: '#1a1a1a'
                        });
                        
                        // Clear form
                        document.getElementById('changePasswordForm').reset();
                        
                        // Reset requirement indicators
                        document.querySelectorAll('.change-password-requirement').forEach(req => {
                            req.classList.remove('valid', 'invalid');
                        });
                        
                    } else {
                        if (data.message === 'Current password is incorrect') {
                            document.getElementById('currentPassword').classList.add('change-password-error');
                        }
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Update Failed',
                            text: data.message || 'Failed to update password. Please try again.'
                        });
                    }
                } catch (error) {
                    loadingAlert.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'Network Error',
                        text: 'Please check your connection and try again.'
                    });
                }
            }
        });
    </script>
</body>
</html>