<%- include("../partials/user/header") %>

<!-- Start shop -->
<section>
  <div class="cs_height_140shop cs_height_lg_80"></div>
  <div class="container-fluid">
    <div class="row cs_gap_y_70">
      <div class="col-lg-3">
        <div class="cs_filter_sidebar">
          <div class="cs_filter_sidebar_heading cs_medium">
            <div class="cs_filter_sidebar_heading_in">
              <svg width="20" height="12" viewBox="0 0 20 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_395_2711)">
                  <path d="M14.2249 3.46555C12.5384 3.46555 10.8518 3.46555 9.16531 3.4598C8.99666 3.4598 8.93268 3.51153 8.88034 3.6667C8.49651 4.81038 7.42643 5.569 6.22259 5.56325C5.00712 5.56325 3.93123 4.78739 3.55903 3.63796C3.5125 3.49429 3.44853 3.45406 3.30314 3.4598C2.43079 3.46555 1.55845 3.46555 0.686101 3.4598C0.360425 3.4598 0.08709 3.22992 0.0231179 2.93681C-0.0466698 2.62072 0.0987213 2.29314 0.395319 2.1667C0.523263 2.11498 0.67447 2.09199 0.819861 2.09199C1.64568 2.08624 2.47732 2.08624 3.30314 2.09199C3.44853 2.09199 3.5125 2.05176 3.55903 1.90808C3.93123 0.770148 4.99549 0.0057803 6.20515 3.31758e-05C7.42062 -0.00571395 8.48488 0.735665 8.86871 1.88509C8.92687 2.0575 9.00829 2.09199 9.17694 2.09199C12.4744 2.08624 15.7777 2.08624 19.0752 2.08624C19.145 2.08624 19.2206 2.08624 19.2903 2.08624C19.7091 2.10923 19.994 2.39658 19.994 2.78739C19.9882 3.17819 19.6974 3.4598 19.2729 3.46555C18.3133 3.4713 17.3537 3.46555 16.3942 3.46555C15.6788 3.46555 14.9519 3.46555 14.2249 3.46555ZM4.80358 2.7759C4.80358 3.5575 5.43748 4.18969 6.22259 4.18969C7.00189 4.18969 7.6358 3.56325 7.64161 2.79888C7.64743 2.01727 7.01934 1.38509 6.22841 1.37934C5.43748 1.3736 4.80358 1.99429 4.80358 2.7759Z" fill="currentColor" />
                  <path d="M16.5167 8.53426C17.4064 8.53426 18.2846 8.53426 19.1628 8.53426C19.2791 8.53426 19.3954 8.53426 19.5059 8.56299C19.8083 8.64345 20.006 8.93081 20.0002 9.2469C19.9886 9.5515 19.7792 9.81587 19.4768 9.88483C19.3779 9.90782 19.2733 9.91357 19.1744 9.91357C18.3486 9.91357 17.5169 9.91931 16.6911 9.91357C16.5515 9.91357 16.4934 9.94805 16.4469 10.086C16.063 11.2412 15.0046 11.9998 13.7833 12.0055C12.5678 12.0055 11.5094 11.2584 11.1256 10.109C11.0674 9.9423 10.986 9.91357 10.829 9.91357C7.51403 9.91931 4.19912 9.91931 0.890016 9.91357C0.773703 9.91357 0.65739 9.91357 0.541077 9.88483C0.192139 9.81012 -0.0230402 9.51127 0.00603803 9.15495C0.0293006 8.82161 0.29682 8.55725 0.645759 8.54C0.732994 8.53426 0.820228 8.53426 0.907463 8.53426C4.20493 8.53426 7.50822 8.53426 10.8057 8.54C10.9802 8.54 11.0674 8.50552 11.1314 8.32161C11.5094 7.18368 12.5911 6.43081 13.7949 6.43656C14.9988 6.4423 16.0688 7.21242 16.4469 8.35035C16.4701 8.40207 16.4934 8.46529 16.5167 8.53426ZM13.7717 10.6205C14.5568 10.6262 15.1907 10.0113 15.1965 9.24115C15.2023 8.4538 14.5859 7.82161 13.7949 7.81012C13.0098 7.79862 12.3585 8.43081 12.3527 9.20667C12.3527 9.98828 12.9807 10.6147 13.7717 10.6205Z" fill="currentColor" />
                </g>
                <defs>
                  <clipPath id="clip0_395_2711">
                    <rect width="20" height="12" fill="white" />
                  </clipPath>
                </defs>
              </svg>
              <span>Filter</span>
            </div>
          </div>
         <form method="GET" id="filterForm" action="/shop">
  <!-- Preserve existing query parameters -->
  <% if (search) { %>
    <input type="hidden" name="search" value="<%= search %>">
  <% } %>
  <% if (sort) { %>
    <input type="hidden" name="sort" value="<%= sort %>">
  <% } %>
  <% if (selectedSize) { %>
    <input type="hidden" name="size" value="<%= selectedSize %>">
  <% } %>
  <!-- Categories -->
  <div class="cs_filter_widget">
    <h3 class="cs_filter_widget_title cs_medium cs_fs_18">Categories <span></span></h3>
    <ul class="cs_filter_category cs_mp0">
      <% categories.forEach(cat => { %>
        <li>
          <div class="cs_custom_check">
            <input type="checkbox"?? name="categories" value="<%= cat.name %>" <% if (selectedCategories.includes(cat.name)) { %>checked<% } %>>
            <label><%= cat.name %></label>
          </div>
        </li>
      <% }) %>
    </ul>
  </div>
  <!-- Price -->
  <div class="cs_filter_widget">
    <h3 class="cs_filter_widget_title cs_medium cs_fs_18">Price <span></span></h3>
    <div class="cs_price_inputs">
      <input type="number" name="minPrice" id="minPrice" value="<%= selectedMinPrice || '' %>" placeholder="From" min="0" step="1">
      <input type="number" name="maxPrice" id="maxPrice" value="<%= selectedMaxPrice || '' %>" placeholder="To" min="0" step="1">
    </div>
  </div>
  <!-- Size -->
  <div class="cs_filter_widget">
    <h3 class="cs_filter_widget_title cs_medium cs_fs_18">Size <span></span></h3>
    <ul class="cs_size_filter_list cs_mp0">
      <li>
        <input type="radio" name="size" value="" <% if (selectedSize === '') { %>checked<% } %>>
        <span>All</span>
      </li>
      <li>
        <input type="radio" name="size" value="S" <% if (selectedSize === 'S') { %>checked<% } %>>
        <span>S</span>
      </li>
      <li>
        <input type="radio" name="size" value="M" <% if (selectedSize === 'M') { %>checked<% } %>>
        <span>M</span>
      </li>
      <li>
        <input type="radio" name="size" value="L" <% if (selectedSize === 'L') { %>checked<% } %>>
        <span>L</span>
      </li>
      <li>
        <input type="radio" name="size" value="XL" <% if (selectedSize === 'XL') { %>checked<% } %>>
        <span>XL</span>
      </li>
    </ul>
  </div>
<a href="/shop" class="small-btn">Clear All</a>
</form>

        </div>
      </div><!-- .col -->
      <div class="col-lg-9">
        <h2 class="cs_section_title">Shop All</h2>
        <div class="cs_sort_section">
          <div class="cs_sort_number">
  <p class="cs_medium mb-0">Showing <%= (page - 1) * 9 + 1 %>–<%= Math.min(page * 9, total) %> of <%= total %> results</p>
</div>
          <div class="cs_sort_search">
            <form method="GET" action="/shop" id="searchForm">
              <% if (selectedCategories.length > 0) { %>
                <% selectedCategories.forEach(category => { %>
                  <input type="hidden" name="categories" value="<%= category %>">
                <% }) %>
              <% } %>
              <% if (selectedSize) { %>
                <input type="hidden" name="size" value="<%= selectedSize %>">
              <% } %>
              <% if (selectedMinPrice) { %>
                <input type="hidden" name="minPrice" value="<%= selectedMinPrice %>">
              <% } %>
              <% if (selectedMaxPrice) { %>
                <input type="hidden" name="maxPrice" value="<%= selectedMaxPrice %>">
              <% } %>
              <% if (sort) { %>
                <input type="hidden" name="sort" value="<%= sort %>">
              <% } %>
              <div class="cs_search_input_wrapper">
                <input type="text" name="search" id="searchInput" value="<%= search || '' %>" placeholder="Search...">
                <button type="submit" class="cs_search_btn">
                  <i class="fa fa-search"></i>
                </button>
                <% if (search) { %>
                  <button type="button" class="cs_clear_btn" id="clearSearchBtn">
                    <i class="fa fa-times"></i>
                  </button>
                <% } %>
              </div>
            </form>
          </div>
          <div class="cs_sort_wrap">
            <div class="cs_sort">
              <select name="sort" id="sortSelect">
                <option value="latest" <% if (sort === 'latest') { %>selected<% } %>>Sort By Latest</option>
                <option value="low" <% if (sort === 'low') { %>selected<% } %>>Sort By Low Price</option>
                <option value="high" <% if (sort === 'high') { %>selected<% } %>>Sort By High Price</option>
                <option value="az" <% if (sort === 'az') { %>selected<% } %>>Sort By A - Z</option>
                <option value="za" <% if (sort === 'za') { %>selected<% } %>>Sort By Z - A</option>
              </select>
            </div>
            <div class="cs_view">
              <span class="cs_viev_icon cs_grid_btn active">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M0.0102539 1.14031C0.0362956 1.07235 0.0571289 1.00963 0.0779622 0.941678C0.260254 0.392837 0.755046 0.0112627 1.32796 0.00603568C2.73942 0.000808628 4.15088 -0.00441842 5.56234 0.00603568C6.2863 0.0112627 6.87484 0.607146 6.88004 1.33371C6.89046 2.74501 6.89046 4.15631 6.88004 5" fill="none" />
                </svg>
              </span>
              <span class="cs_viev_icon cs_list_btn">
                <svg width="21" height="16" viewBox="0 0 21 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <!-- SVG content omitted for brevity -->
                </svg>
              </span>
            </div>
          </div>
        </div>

        <!-- Products Starts -->
        <div class="container">
          <% if (!products || products.length === 0) { %>
            <div class="cs_no_products">
              <p class="mb-0">No products found.</p>
            </div>
          <% } %>
          <div class="cs_product_grid cs_product_grid_3">
            <% products.forEach(product => { %>
              <div class="cs_product">
                <div class="cs_product_thumb">
                  <a href="/product/<%= product._id %>">
                    <img src="/Uploads/products/<%= product.productImage[0] %>" alt="<%= product.productName %>">
                  </a>
                  <a href="#" class="cs_wishlist_btn" data-product-id="<%= product._id %>">
                    <i class="fa-regular fa-heart"></i>
                  </a>

                  <% if (product.status.toLowerCase() === "out of stock") { %>
    <!--  Out of stock label instead of button -->
    <span class="badge bg-danger cs_outofstock_label">Out of Stock</span>
  <% } else { %>
    <!--  Add to Cart button for available items -->
<button type="button" class="cs_cart_btn select-stock-btn" data-product-id="<%= product._id %>">
  <i class="fa-solid fa-cart-plus"></i>
</button>

  <% } %>
                </div>
                <div class="cs_product_info">
                  <h3 class="cs_product_title">
                    <a href="/product/<%= product._id %>"><%= product.productName %></a>
                  </h3>
                  <div class="cs_product_price">
                    <% if (product.offer && product.offer.hasOffer) { %>
                      <!-- Show offer pricing -->
                      <div class="price-container">
                        <span class="cs_original_price">₹<%= product.offer.regularPrice.toLocaleString() %></span>
                        <span class="cs_current_price">₹<%= product.offer.finalPrice.toLocaleString() %></span>
                        <span class="cs_discount_percentage">-<%= product.offer.discountPercentage %>% OFF</span>
                      </div>
                    <% } else { %>
                      <!-- Show regular pricing -->
                      <div class="price-container">
                        <span class="cs_current_price">₹<%= product.regularPrice.toLocaleString() %></span>
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
            <% }) %>
          </div>
        </div>
        <!-- Products Ends-->

        <div class="cs_height_75 cs_height_lg_50"></div>
       <ul class="cs_pagination cs_fs_21 cs_semibold cs_mp0">
  <% for (let i = 1; i <= pages; i++) { %>
    <li class="cs_page_item <%= page === i ? 'active' : '' %>">
      <a class="cs_page_link" href="?page=<%= i %>&<%= queryString %>"><%= i.toString().padStart(2, '0') %></a>
    </li>
  <% } %>
  <% if (page < pages) { %>
    <li class="cs_page_item">
      <a class="cs_page_link" href="?page=<%= page + 1 %>&<%= queryString %>">
        <i class="fa-solid fa-arrow-right"></i>
      </a>
    </li>
  <% } %>
</ul>
      </div><!-- .col -->
    </div>
  </div>
  <div class="cs_height_140 cs_height_lg_80"></div>
  <hr>
<div class="modal fade" id="stockSelectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="stockSelectForm">
        <input type="hidden" id="selectedProductId">
        
        <div class="modal-header">
          <h5 class="modal-title">Select Size</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        
        <div class="modal-body">
          <div id="stockOptions" class="size-options"></div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Add to Cart</button>
        </div>
      </form>
    </div>
  </div>
</div>

</section>
<!-- End shop -->

<!-- Footer content omitted for brevity -->

<script>
  // Handle filter changes (checkboxes and radio buttons)
  document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
    input.addEventListener('change', () => {
      document.getElementById('filterForm').submit();
    });
  });

  // Handle price input changes
  const minPriceInput = document.getElementById('minPrice');
  const maxPriceInput = document.getElementById('maxPrice');
  [minPriceInput, maxPriceInput].forEach(input => {
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        // Ensure both inputs are included in submission
        minPriceInput.value = minPriceInput.value || ''; // Preserve empty or existing value
        maxPriceInput.value = maxPriceInput.value || ''; // Preserve empty or existing value
        document.getElementById('filterForm').submit();
      }
    });
  });

  // Handle sort change
  document.getElementById('sortSelect').addEventListener('change', (e) => {
    const url = new URL(window.location);
    url.searchParams.set('sort', e.target.value);
    url.searchParams.set('page', '1'); // Reset to page 1
    window.location = url;
  });

  // Handle toggle buttons (if any)
  document.querySelectorAll('.cs_toggle_btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const content = btn.parentElement.nextElementSibling;
      content.classList.toggle('active');
      btn.textContent = content.classList.contains('active') ? '-' : '+';
    });
  });

  // Search functionality
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const searchForm = document.getElementById('searchForm');

    // Show/hide clear button based on input
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        const wrapper = this.parentElement;
        const clearBtn = wrapper.querySelector('.cs_clear_btn');
        
        if (this.value.trim() !== '') {
          if (!clearBtn) {
            const newClearBtn = document.createElement('button');
            newClearBtn.type = 'button';
            newClearBtn.className = 'cs_clear_btn';
            newClearBtn.innerHTML = '<i class="fa fa-times"></i>';
            newClearBtn.addEventListener('click', clearSearch);
            wrapper.appendChild(newClearBtn);
          }
        } else {
          if (clearBtn) {
            clearBtn.remove();
          }
        }
      });
    }

    // Clear search functionality
    function clearSearch() {
      if (searchInput) {
        searchInput.value = '';
        const wrapper = searchInput.parentElement;
        const clearBtn = wrapper.querySelector('.cs_clear_btn');
        if (clearBtn) {
          clearBtn.remove();
        }
        // Submit form to clear search
        searchForm.submit();
      }
    }

    // Add event listener to existing clear button if it exists
    if (clearSearchBtn) {
      clearSearchBtn.addEventListener('click', clearSearch);
    }
  });

  //Add to cart

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".select-stock-btn").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.preventDefault();
      const productId = btn.dataset.productId;
      document.getElementById("selectedProductId").value = productId;

      try {
        const res = await fetch(`/getStock/${productId}`);
        const data = await res.json();

        if (data.success) {
          const stockOptions = document.getElementById("stockOptions");
          stockOptions.innerHTML = "";

          // Check if there are any available sizes
          const availableSizes = data.stock.filter(item => item.quantity > 0);
          
          if (availableSizes.length === 0) {
            stockOptions.innerHTML = '<p class="text-danger">No sizes available</p>';
            return;
          }

          // Create radio buttons for each available size
          availableSizes.forEach((item, index) => {
            const div = document.createElement("div");
            div.className = "form-check";
            
            div.innerHTML = `
              <input class="form-check-input" type="radio" name="selectedSize" 
                     id="size${index}" value="${item.size}" ${index === 0 ? 'checked' : ''}>
              <label class="form-check-label" for="size${index}">
                ${item.size} (${item.quantity} left)
              </label>
            `;
            
            stockOptions.appendChild(div);
          });

          // Show the modal
          new bootstrap.Modal(document.getElementById("stockSelectModal")).show();
        }
      } catch (err) {
        console.error("Error fetching stock:", err);
        alert("Error loading sizes. Please try again.");
      }
    });
  });

  // Handle Add to Cart form submit
  document.getElementById("stockSelectForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const productId = document.getElementById("selectedProductId").value;
    const size = document.querySelector("input[name='selectedSize']:checked")?.value;
    
    console.log("Selected size:", size); // Debug log

    if (!size) {
      alert("Please select a size");
      return;
    }

    try {
      // Get the current price from the product card (with offer if applicable)
      const productCard = document.querySelector(`[data-product-id="${productId}"]`).closest('.cs_product');
      const priceElement = productCard.querySelector('.cs_current_price');
      const priceText = priceElement.textContent.replace('₹', '').replace(',', '').trim();
      const finalPrice = parseFloat(priceText);

      if (isNaN(finalPrice)) {
        Swal.fire({
          icon: 'error',
          title: 'Price Error',
          text: 'Unable to determine product price',
          confirmButtonColor: '#e74c3c'
        });
        return;
      }

      const res = await fetch("/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          productId, 
          size, 
          quantity: 1,
          price: finalPrice // Pass the offer price
        })
      });

      const data = await res.json();
      
      if (data.success) {
        // Use SweetAlert for better UX
        Swal.fire({
          icon: "success",
          title: "Success!",
          text: "Product added to cart!",
          timer: 1500,
          showConfirmButton: false
        });
        
        // Close the modal
        bootstrap.Modal.getInstance(document.getElementById("stockSelectModal")).hide();
      } else {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: data.message || "Something went wrong"
        });
      }
    } catch (err) {
      console.error("Add to cart error:", err);
      Swal.fire({
        icon: "error",
        title: "Error",
        text: "Could not add to cart. Please try again."
      });
    }
  });
});


  document.addEventListener("DOMContentLoaded", () => {
  // Wishlist buttons
  const wishlistBtns = document.querySelectorAll(".cs_wishlist_btn");

  wishlistBtns.forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.preventDefault();
      const productId = btn.getAttribute("data-product-id");

      try {
        const res = await fetch("/wishlist/add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productId })
        });

        const data = await res.json();

        if (data.success) {
          Swal.fire({
            icon: "success",
            title: "Added to Wishlist",
            text: data.message,
            timer: 1500,
            showConfirmButton: false
          });
          // Optionally, toggle the heart icon to filled
          btn.querySelector("i").classList.remove("fa-regular");
          btn.querySelector("i").classList.add("fa-solid");
        } else if (data.exists) {
          Swal.fire({
            icon: "info",
            title: "Already in Wishlist",
            text: data.message,
            timer: 1500,
            showConfirmButton: false
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: data.message || "Something went wrong"
          });
        }

      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Could not add to wishlist"
        });
        console.error(err);
      }
    });
  });
});

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

