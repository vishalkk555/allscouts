<%- include("../partials/user/header") %>

<style>
.edit-address-error {
    border-color: #ef4444 !important;
}

.edit-address-error-message {
    color: #ef4444;
    font-size: 0.875rem;
    margin-top: 0.25rem;
    display: block;
}
</style>

<body class="edit-address-body">
   
    <!-- Main Container -->
    <div class="edit-address-container">
        <!-- Sidebar -->
        <aside class="edit-address-sidebar">
            <ul class="edit-address-sidebar-menu">
                <li><a href="/profile">Profile</a></li>
                <li><a href="#">Orders</a></li>
                <li><a href="/addresses" class="edit-address-active">Addresses</a></li>
                <li><a href="#">Wallet</a></li>
                <li><a href="/change-password">Change Password</a></li>
            </ul>
            <div class="edit-address-logout-section">
                <button class="edit-address-logout-btn">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="edit-address-main-content">
            <a href="/addresses" class="edit-address-back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                </svg>
                Back to Addresses
            </a>

            <h1 class="edit-address-page-title">Edit Address</h1>
            <p class="edit-address-page-subtitle">Update your delivery address information</p>

            <!-- Form -->
            <form id="editAddressForm" class="edit-address-form">
                <!-- Hidden field for address ID -->
                <input type="hidden" id="addressId" name="addressId" value="<%= address._id %>">
                
                <!-- Contact Information -->
                <h3 class="edit-address-section-title">Contact Information</h3>
                
                <div class="edit-address-form-row">
                    <div class="edit-address-form-group">
                        <label for="name" class="edit-address-form-label">
                            Full Name <span class="edit-address-required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="name" 
                            name="name" 
                            class="edit-address-form-input"
                            placeholder="Enter full name"
                            value="<%= address.name %>"
                            required
                        >
                    </div>

                    <div class="edit-address-form-group">
                        <label for="email" class="edit-address-form-label">
                            Email Address <span class="edit-address-required">*</span>
                        </label>
                        <input 
                            type="email" 
                            id="email" 
                            name="email" 
                            class="edit-address-form-input"
                            placeholder="Enter email address"
                            value="<%= address.email %>"
                            required
                        >
                    </div>
                </div>

                <div class="edit-address-form-group">
                    <label for="number" class="edit-address-form-label">
                        Phone Number <span class="edit-address-required">*</span>
                    </label>
                    <input 
                        type="tel" 
                        id="number" 
                        name="number" 
                        class="edit-address-form-input"
                        placeholder="Enter 10-digit phone number"
                        value="<%= address.number %>"
                        maxlength="10"
                        required
                    >
                </div>

                <!-- Address Information -->
                <h3 class="edit-address-section-title">Address Details</h3>

                <div class="edit-address-form-group">
                    <label for="houseName" class="edit-address-form-label">
                        House/Building Name <span class="edit-address-required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="houseName" 
                        name="houseName" 
                        class="edit-address-form-input"
                        placeholder="Enter house/building name and number"
                        value="<%= address.houseName %>"
                        required
                    >
                </div>

                <div class="edit-address-form-group">
                    <label for="street" class="edit-address-form-label">
                        Street Address <span class="edit-address-required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="street" 
                        name="street" 
                        class="edit-address-form-input"
                        placeholder="Enter street address"
                        value="<%= address.street %>"
                        required
                    >
                </div>

                <div class="edit-address-form-row">
                    <div class="edit-address-form-group">
                        <label for="city" class="edit-address-form-label">
                            City <span class="edit-address-required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="city" 
                            name="city" 
                            class="edit-address-form-input"
                            placeholder="Enter city"
                            value="<%= address.city %>"
                            required
                        >
                    </div>

                    <div class="edit-address-form-group">
                        <label for="state" class="edit-address-form-label">
                            State <span class="edit-address-required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="state" 
                            name="state" 
                            class="edit-address-form-input"
                            placeholder="Enter state"
                            value="<%= address.state %>"
                            required
                        >
                    </div>
                </div>

                <div class="edit-address-form-row">
                    <div class="edit-address-form-group">
                        <label for="country" class="edit-address-form-label">
                            Country <span class="edit-address-required">*</span>
                        </label>
                        <select id="country" name="country" class="edit-address-form-select" required>
                            <option value="">Select Country</option>
                            <option value="India" <%= address.country === 'India' ? 'selected' : '' %>>India</option>
                            <option value="United States" <%= address.country === 'United States' ? 'selected' : '' %>>United States</option>
                            <option value="Canada" <%= address.country === 'Canada' ? 'selected' : '' %>>Canada</option>
                            <option value="United Kingdom" <%= address.country === 'United Kingdom' ? 'selected' : '' %>>United Kingdom</option>
                            <option value="Australia" <%= address.country === 'Australia' ? 'selected' : '' %>>Australia</option>
                        </select>
                    </div>

                    <div class="edit-address-form-group">
                        <label for="pincode" class="edit-address-form-label">
                            Pincode <span class="edit-address-required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="pincode" 
                            name="pincode" 
                            class="edit-address-form-input"
                            placeholder="Enter pincode"
                            value="<%= address.pincode %>"
                            maxlength="6"
                            required
                        >
                    </div>
                </div>

                <!-- Address Type -->
                <div class="edit-address-form-group">
                    <label class="edit-address-form-label">
                        Save Address As <span class="edit-address-required">*</span>
                    </label>
                    <div class="edit-address-radio-group">
                        <div class="edit-address-radio-item">
                            <input 
                                type="radio" 
                                id="saveAsHome" 
                                name="saveAs" 
                                value="Home" 
                                class="edit-address-radio-input"
                                <%= address.saveAs === 'Home' ? 'checked' : '' %>
                                required
                            >
                            <label for="saveAsHome" class="edit-address-radio-label">Home</label>
                        </div>
                        <div class="edit-address-radio-item">
                            <input 
                                type="radio" 
                                id="saveAsWork" 
                                name="saveAs" 
                                value="Work" 
                                class="edit-address-radio-input"
                                <%= address.saveAs === 'Work' ? 'checked' : '' %>
                                required
                            >
                            <label for="saveAsWork" class="edit-address-radio-label">Work</label>
                        </div>
                        <div class="edit-address-radio-item">
                            <input 
                                type="radio" 
                                id="saveAsOther" 
                                name="saveAs" 
                                value="Other" 
                                class="edit-address-radio-input"
                                <%= address.saveAs === 'Other' ? 'checked' : '' %>
                                required
                            >
                            <label for="saveAsOther" class="edit-address-radio-label">Other</label>
                        </div>
                    </div>
                    <span id="saveAs-error" class="edit-address-error-message" style="display: none;"></span>
                </div>

                <!-- Default Address Option -->
                <div class="edit-address-checkbox-group">
                    <div class="edit-address-checkbox-item">
                        <input 
                            type="checkbox" 
                            id="isDefault" 
                            name="isDefault" 
                            class="edit-address-checkbox-input"
                            <%= address.isDefault ? 'checked' : '' %>
                        >
                        <label for="isDefault" class="edit-address-checkbox-label">
                            Set as default address
                        </label>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="edit-address-form-actions">
                    <button type="button" class="edit-address-btn edit-address-btn-cancel" onclick="cancelEdit()">
                        Cancel
                    </button>
                    <button type="submit" class="edit-address-btn edit-address-btn-update">
                        Update Address
                    </button>
                </div>
            </form>
        </main>
    </div>

  <script>
    // --- Validation Functions ---
    function validateName(name) {
        return /^[a-zA-Z\s]{2,50}$/.test(name.trim());
    }

    function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function validatePhoneNumber(phone) {
        return /^[6-9]\d{9}$/.test(phone);
    }

    function validatePincode(pincode) {
        return /^\d{6}$/.test(pincode);
    }

    function validateText(text, minLength = 2, maxLength = 100) {
        return text.trim().length >= minLength && text.trim().length <= maxLength;
    }

    function validateCity(city) {
        return /^[a-zA-Z\s]{2,50}$/.test(city.trim());
    }

    function validateState(state) {
        return /^[a-zA-Z\s]{2,50}$/.test(state.trim());
    }

    function validateStreet(street) {
        return /^[a-zA-Z0-9\s,.-]{2,100}$/.test(street.trim());
    }

    // --- Input Format Restrictions ---
    document.getElementById('number').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 10) value = value.slice(0, 10);
        e.target.value = value;
    });

    document.getElementById('pincode').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 6) value = value.slice(0, 6);
        e.target.value = value;
    });

    // --- Cancel Edit Confirmation ---
    function cancelEdit() {
        Swal.fire({
            title: 'Cancel Changes?',
            text: 'Are you sure you want to cancel? All changes will be lost.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Yes, cancel!',
            cancelButtonText: 'Continue editing'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    icon: 'info',
                    title: 'Changes Cancelled',
                    text: 'Redirecting back to addresses...',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = '/addresses';
                });
            }
        });
    }

    // --- Error Handling Helpers ---
    function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        field.classList.add('edit-address-error');
        const existing = field.parentNode.querySelector('.edit-address-error-message');
        if (existing) {
            existing.textContent = message;
            existing.style.display = 'block';
        } else {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'edit-address-error-message';
            errorDiv.textContent = message;
            field.parentNode.appendChild(errorDiv);
        }
    }

    function clearFieldError(fieldId) {
        const field = document.getElementById(fieldId);
        field.classList.remove('edit-address-error');
        const existing = field.parentNode.querySelector('.edit-address-error-message');
        if (existing) {
            existing.style.display = 'none';
        }
    }

    // --- Real-time Validation (on blur) ---
    document.getElementById('name').addEventListener('blur', function () {
        if (this.value.trim() === '') {
            showFieldError('name', 'Full name is required');
        } else if (!validateName(this.value)) {
            showFieldError('name', 'Name should contain only letters and spaces (2–50 characters)');
        } else {
            clearFieldError('name');
        }
    });

    document.getElementById('email').addEventListener('blur', function () {
        if (this.value.trim() === '') {
            showFieldError('email', 'Email address is required');
        } else if (!validateEmail(this.value)) {
            showFieldError('email', 'Please enter a valid email address');
        } else {
            clearFieldError('email');
        }
    });

    document.getElementById('number').addEventListener('blur', function () {
        if (this.value.trim() === '') {
            showFieldError('number', 'Phone number is required');
        } else if (!validatePhoneNumber(this.value)) {
            showFieldError('number', 'Phone number should be 10 digits starting with 6–9');
        } else {
            clearFieldError('number');
        }
    });

    document.getElementById('houseName').addEventListener('blur', function () {
        if (this.value.trim() === '') {
            showFieldError('houseName', 'House/Building name is required');
        } else if (!validateText(this.value)) {
            showFieldError('houseName', 'House name should be 2–100 characters');
        } else {
            clearFieldError('houseName');
        }
    });

    document.getElementById('street').addEventListener('blur', function () {
        if (this.value.trim() === '') {
            showFieldError('street', 'Street address is required');
        } else if (!validateStreet(this.value)) {
            showFieldError('street', 'Street address can only contain letters, numbers, spaces, commas, dots and hyphens');
        } else {
            clearFieldError('street');
        }
    });

    document.getElementById('city').addEventListener('blur', function () {
        if (this.value.trim() === '') {
            showFieldError('city', 'City is required');
        } else if (!validateCity(this.value)) {
            showFieldError('city', 'City name can only contain letters and spaces (2–50 characters)');
        } else {
            clearFieldError('city');
        }
    });

    document.getElementById('state').addEventListener('blur', function () {
        if (this.value.trim() === '') {
            showFieldError('state', 'State is required');
        } else if (!validateState(this.value)) {
            showFieldError('state', 'State name can only contain letters and spaces (2–50 characters)');
        } else {
            clearFieldError('state');
        }
    });

    document.getElementById('country').addEventListener('blur', function () {
        if (this.value === '') {
            showFieldError('country', 'Please select a country');
        } else {
            clearFieldError('country');
        }
    });

    document.getElementById('pincode').addEventListener('blur', function () {
        if (this.value.trim() === '') {
            showFieldError('pincode', 'Pincode is required');
        } else if (!validatePincode(this.value)) {
            showFieldError('pincode', 'Pincode should be exactly 6 digits');
        } else {
            clearFieldError('pincode');
        }
    });

    // --- Form Submit ---
    document.getElementById('editAddressForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        let hasErrors = false;
        let firstErrorField = null;

        // Clear all previous errors
        document.querySelectorAll('.edit-address-form-input, .edit-address-form-select').forEach(input => clearFieldError(input.id));
        document.getElementById('saveAs-error').style.display = 'none';

        // --- Validation ---
        if (data.name.trim() === '') {
            showFieldError('name', 'Full name is required');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('name');
        } else if (!validateName(data.name)) {
            showFieldError('name', 'Name should contain only letters and spaces (2–50 characters)');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('name');
        }

        if (data.email.trim() === '') {
            showFieldError('email', 'Email address is required');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('email');
        } else if (!validateEmail(data.email)) {
            showFieldError('email', 'Please enter a valid email address');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('email');
        }

        if (data.number.trim() === '') {
            showFieldError('number', 'Phone number is required');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('number');
        } else if (!validatePhoneNumber(data.number)) {
            showFieldError('number', 'Phone number should be 10 digits starting with 6–9');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('number');
        }

        if (data.houseName.trim() === '') {
            showFieldError('houseName', 'House/Building name is required');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('houseName');
        } else if (!validateText(data.houseName)) {
            showFieldError('houseName', 'House name should be 2–100 characters');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('houseName');
        }

        if (data.street.trim() === '') {
            showFieldError('street', 'Street address is required');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('street');
        } else if (!validateStreet(data.street)) {
            showFieldError('street', 'Street address can only contain letters, numbers, spaces, commas, dots and hyphens');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('street');
        }

        if (data.city.trim() === '') {
            showFieldError('city', 'City is required');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('city');
        } else if (!validateCity(data.city)) {
            showFieldError('city', 'City name can only contain letters and spaces (2–50 characters)');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('city');
        }

        if (data.state.trim() === '') {
            showFieldError('state', 'State is required');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('state');
        } else if (!validateState(data.state)) {
            showFieldError('state', 'State name can only contain letters and spaces (2–50 characters)');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('state');
        }

        if (!data.country) {
            showFieldError('country', 'Please select a country');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('country');
        }

        if (data.pincode.trim() === '') {
            showFieldError('pincode', 'Pincode is required');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('pincode');
        } else if (!validatePincode(data.pincode)) {
            showFieldError('pincode', 'Pincode should be exactly 6 digits');
            hasErrors = true;
            if (!firstErrorField) firstErrorField = document.getElementById('pincode');
        }

        if (!data.saveAs) {
            const errorEl = document.getElementById('saveAs-error');
            errorEl.textContent = 'Please select how to save this address';
            errorEl.style.display = 'block';
            hasErrors = true;
        }

        if (hasErrors) {
            if (firstErrorField) {
                firstErrorField.focus();
                firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        // Confirm update
        const confirm = await Swal.fire({
            title: 'Update Address?',
            text: 'Are you sure you want to update this address?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#1a1a1a',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Yes, update it!'
        });

        if (!confirm.isConfirmed) return;

        Swal.fire({
            title: 'Updating...',
            text: 'Please wait while we save your changes.',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            data.number = parseInt(data.number);
            data.isDefault = document.getElementById('isDefault').checked;

            const res = await fetch('/updateAddress', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await res.json();
            Swal.close();

            if (!res.ok || !result.success) {
                Swal.fire('Update Failed', result.message || 'Something went wrong.', 'error');
                return;
            }

            await Swal.fire({
                icon: 'success',
                title: 'Address Updated!',
                text: 'Your address has been updated successfully.',
                confirmButtonColor: '#1a1a1a'
            });

            window.location.href = '/addresses';

        } catch (err) {
            Swal.close();
            Swal.fire('Error', 'Network error. Please try again later.', 'error');
        }
    });
</script>

</body>
</html>