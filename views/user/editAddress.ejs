<%- include("../partials/user/header") %>

<body class="edit-address-body">
   
    <!-- Main Container -->
    <div class="edit-address-container">
        <!-- Sidebar -->
        <aside class="edit-address-sidebar">
            <ul class="edit-address-sidebar-menu">
                <li><a href="/profile">Profile</a></li>
                <li><a href="#">Orders</a></li>
                <li><a href="/addresses" class="edit-address-active">Addresses</a></li>
                <li><a href="#">Wallet</a></li>
                <li><a href="/change-password">Change Password</a></li>
            </ul>
            <div class="edit-address-logout-section">
                <button class="edit-address-logout-btn">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="edit-address-main-content">
            <a href="/addresses" class="edit-address-back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                </svg>
                Back to Addresses
            </a>

            <h1 class="edit-address-page-title">Edit Address</h1>
            <p class="edit-address-page-subtitle">Update your delivery address information</p>

            <!-- Form -->
            <form id="editAddressForm" class="edit-address-form">
                <!-- Hidden field for address ID -->
                <input type="hidden" id="addressId" name="addressId" value="<%= address._id %>">
                
                <!-- Contact Information -->
                <h3 class="edit-address-section-title">Contact Information</h3>
                
                <div class="edit-address-form-row">
                    <div class="edit-address-form-group">
                        <label for="name" class="edit-address-form-label">
                            Full Name <span class="edit-address-required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="name" 
                            name="name" 
                            class="edit-address-form-input"
                            placeholder="Enter full name"
                            value="<%= address.name %>"
                            required
                        >
                    </div>

                    <div class="edit-address-form-group">
                        <label for="email" class="edit-address-form-label">
                            Email Address <span class="edit-address-required">*</span>
                        </label>
                        <input 
                            type="email" 
                            id="email" 
                            name="email" 
                            class="edit-address-form-input"
                            placeholder="Enter email address"
                            value="<%= address.email %>"
                            required
                        >
                    </div>
                </div>

                <div class="edit-address-form-group">
                    <label for="number" class="edit-address-form-label">
                        Phone Number <span class="edit-address-required">*</span>
                    </label>
                    <input 
                        type="tel" 
                        id="number" 
                        name="number" 
                        class="edit-address-form-input"
                        placeholder="Enter 10-digit phone number"
                        value="<%= address.number %>"
                        maxlength="10"
                        required
                    >
                </div>

                <!-- Address Information -->
                <h3 class="edit-address-section-title">Address Details</h3>

                <div class="edit-address-form-group">
                    <label for="houseName" class="edit-address-form-label">
                        House/Building Name <span class="edit-address-required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="houseName" 
                        name="houseName" 
                        class="edit-address-form-input"
                        placeholder="Enter house/building name and number"
                        value="<%= address.houseName %>"
                        required
                    >
                </div>

                <div class="edit-address-form-group">
                    <label for="street" class="edit-address-form-label">
                        Street Address <span class="edit-address-required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="street" 
                        name="street" 
                        class="edit-address-form-input"
                        placeholder="Enter street address"
                        value="<%= address.street %>"
                        required
                    >
                </div>

                <div class="edit-address-form-row">
                    <div class="edit-address-form-group">
                        <label for="city" class="edit-address-form-label">
                            City <span class="edit-address-required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="city" 
                            name="city" 
                            class="edit-address-form-input"
                            placeholder="Enter city"
                            value="<%= address.city %>"
                            required
                        >
                    </div>

                    <div class="edit-address-form-group">
                        <label for="state" class="edit-address-form-label">
                            State <span class="edit-address-required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="state" 
                            name="state" 
                            class="edit-address-form-input"
                            placeholder="Enter state"
                            value="<%= address.state %>"
                            required
                        >
                    </div>
                </div>

                <div class="edit-address-form-row">
                    <div class="edit-address-form-group">
                        <label for="country" class="edit-address-form-label">
                            Country <span class="edit-address-required">*</span>
                        </label>
                        <select id="country" name="country" class="edit-address-form-select" required>
                            <option value="">Select Country</option>
                            <option value="India" <%= address.country === 'India' ? 'selected' : '' %>>India</option>
                            <option value="United States" <%= address.country === 'United States' ? 'selected' : '' %>>United States</option>
                            <option value="Canada" <%= address.country === 'Canada' ? 'selected' : '' %>>Canada</option>
                            <option value="United Kingdom" <%= address.country === 'United Kingdom' ? 'selected' : '' %>>United Kingdom</option>
                            <option value="Australia" <%= address.country === 'Australia' ? 'selected' : '' %>>Australia</option>
                        </select>
                    </div>

                    <div class="edit-address-form-group">
                        <label for="pincode" class="edit-address-form-label">
                            Pincode <span class="edit-address-required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="pincode" 
                            name="pincode" 
                            class="edit-address-form-input"
                            placeholder="Enter pincode"
                            value="<%= address.pincode %>"
                            maxlength="6"
                            required
                        >
                    </div>
                </div>

                <!-- Address Type -->
                <div class="edit-address-form-group">
                    <label class="edit-address-form-label">
                        Save Address As <span class="edit-address-required">*</span>
                    </label>
                    <div class="edit-address-radio-group">
                        <div class="edit-address-radio-item">
                            <input 
                                type="radio" 
                                id="saveAsHome" 
                                name="saveAs" 
                                value="Home" 
                                class="edit-address-radio-input"
                                <%= address.saveAs === 'Home' ? 'checked' : '' %>
                                required
                            >
                            <label for="saveAsHome" class="edit-address-radio-label">Home</label>
                        </div>
                        <div class="edit-address-radio-item">
                            <input 
                                type="radio" 
                                id="saveAsWork" 
                                name="saveAs" 
                                value="Work" 
                                class="edit-address-radio-input"
                                <%= address.saveAs === 'Work' ? 'checked' : '' %>
                                required
                            >
                            <label for="saveAsWork" class="edit-address-radio-label">Work</label>
                        </div>
                        <div class="edit-address-radio-item">
                            <input 
                                type="radio" 
                                id="saveAsOther" 
                                name="saveAs" 
                                value="Other" 
                                class="edit-address-radio-input"
                                <%= address.saveAs === 'Other' ? 'checked' : '' %>
                                required
                            >
                            <label for="saveAsOther" class="edit-address-radio-label">Other</label>
                        </div>
                    </div>
                </div>

                <!-- Default Address Option -->
                <div class="edit-address-checkbox-group">
                    <div class="edit-address-checkbox-item">
                        <input 
                            type="checkbox" 
                            id="isDefault" 
                            name="isDefault" 
                            class="edit-address-checkbox-input"
                            <%= address.isDefault ? 'checked' : '' %>
                        >
                        <label for="isDefault" class="edit-address-checkbox-label">
                            Set as default address
                        </label>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="edit-address-form-actions">
                    <button type="button" class="edit-address-btn edit-address-btn-cancel" onclick="cancelEdit()">
                        Cancel
                    </button>
                    <button type="submit" class="edit-address-btn edit-address-btn-update">
                        Update Address
                    </button>
                </div>
            </form>
        </main>
    </div>

  <script>
    // Form validation functions
    function validateName(name) {
        return /^[a-zA-Z\s]{2,50}$/.test(name.trim());
    }

    function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function validatePhoneNumber(phone) {
        return /^[6-9]\d{9}$/.test(phone);
    }

    function validatePincode(pincode) {
        return /^\d{6}$/.test(pincode);
    }

    function validateText(text, minLength = 2, maxLength = 100) {
        return text.trim().length >= minLength && text.trim().length <= maxLength;
    }

    // Format phone number input
    document.getElementById('number').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 10) value = value.slice(0, 10);
        e.target.value = value;
    });

    // Format pincode input
    document.getElementById('pincode').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 6) value = value.slice(0, 6);
        e.target.value = value;
    });

    // Cancel edit confirmation
    function cancelEdit() {
        Swal.fire({
            title: 'Cancel Changes?',
            text: 'Are you sure you want to cancel? All changes will be lost.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Yes, cancel!',
            cancelButtonText: 'Continue editing'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    icon: 'info',
                    title: 'Changes Cancelled',
                    text: 'Redirecting back to addresses...',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = '/addresses';
                });
            }
        });
    }

    // Show inline field error
    function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        field.classList.add('edit-address-error');
        const existingError = field.parentNode.querySelector('.edit-address-error-message');
        if (existingError) existingError.remove();
        const errorDiv = document.createElement('div');
        errorDiv.className = 'edit-address-error-message';
        errorDiv.textContent = message;
        field.parentNode.appendChild(errorDiv);
    }

    // Clear inline error
    function clearFieldError(fieldId) {
        const field = document.getElementById(fieldId);
        field.classList.remove('edit-address-error');
        const existingError = field.parentNode.querySelector('.edit-address-error-message');
        if (existingError) existingError.remove();
    }

    // Submit form handler
    document.getElementById('editAddressForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Clear previous errors
        document.querySelectorAll('.edit-address-form-input, .edit-address-form-select').forEach(input => {
            clearFieldError(input.id);
        });

        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        let hasErrors = false;

        // === VALIDATION SECTION ===
        if (!validateName(data.name)) {
            Swal.fire('Invalid Name', 'Name should contain only letters and spaces (2–50 characters).', 'warning');
            hasErrors = true;
        } else if (!validateEmail(data.email)) {
            Swal.fire('Invalid Email', 'Please enter a valid email address.', 'warning');
            hasErrors = true;
        } else if (!validatePhoneNumber(data.number)) {
            Swal.fire('Invalid Phone Number', 'Phone number should be 10 digits starting with 6–9.', 'warning');
            hasErrors = true;
        } else if (!validateText(data.houseName)) {
            Swal.fire('Invalid House Name', 'House name must be between 2–100 characters.', 'warning');
            hasErrors = true;
        } else if (!validateText(data.street)) {
            Swal.fire('Invalid Street', 'Street name must be between 2–100 characters.', 'warning');
            hasErrors = true;
        } else if (!validateText(data.city)) {
            Swal.fire('Invalid City', 'City name must be between 2–100 characters.', 'warning');
            hasErrors = true;
        } else if (!validateText(data.state)) {
            Swal.fire('Invalid State', 'State name must be between 2–100 characters.', 'warning');
            hasErrors = true;
        } else if (!data.country) {
            Swal.fire('Select Country', 'Please select a country.', 'warning');
            hasErrors = true;
        } else if (!validatePincode(data.pincode)) {
            Swal.fire('Invalid Pincode', 'Pincode must be exactly 6 digits.', 'warning');
            hasErrors = true;
        } else if (!data.saveAs) {
            Swal.fire('Select Address Type', 'Please choose how to save this address (Home / Work / Other).', 'warning');
            hasErrors = true;
        }

        if (hasErrors) return;

        // Confirm update
        const confirm = await Swal.fire({
            title: 'Update Address?',
            text: 'Are you sure you want to update this address?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#1a1a1a',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Yes, update it!'
        });

        if (!confirm.isConfirmed) return;

        Swal.fire({
            title: 'Updating...',
            text: 'Please wait while we save your changes.',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            data.number = parseInt(data.number);
            data.isDefault = document.getElementById('isDefault').checked;

            const res = await fetch('/updateAddress', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await res.json();
            Swal.close();

            if (!res.ok || !result.success) {
                Swal.fire('Update Failed', result.message || 'Something went wrong.', 'error');
                return;
            }

            await Swal.fire({
                icon: 'success',
                title: 'Address Updated!',
                text: 'Your address has been updated successfully.',
                confirmButtonColor: '#1a1a1a'
            });

            window.location.href = '/addresses';

        } catch (err) {
            Swal.close();
            Swal.fire('Error', 'Network error. Please try again later.', 'error');
        }
    });
</script>

</body>
</html>