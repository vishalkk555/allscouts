<%- include("../partials/user/header") %>
<body>
  <!-- Start Cart Page Heading -->
  <section>
    <div class="container">
      <div class="cs_height_80 cs_height_lg_60"></div>
      <div class="cs_shop_page_heading text-center">
        <h1 class="cs_fs_50 cs_bold">Wishlist</h1>
        <div class="cs_shop_breadcamp cs_medium">
          <a href="/">Home</a>
          <svg width="17" height="8" viewBox="0 0 17 8" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M16.3536 4.35355C16.5488 4.15829 16.5488 3.84171 16.3536 3.64645L13.1716 0.464467C12.9763 0.269205 12.6597 0.269205 12.4645 0.464467C12.2692 0.659729 12.2692 0.976312 12.4645 1.17157L15.2929 4L12.4645 6.82843C12.2692 7.02369 12.2692 7.34027 12.4645 7.53553C12.6597 7.7308 12.9763 7.7308 13.1716 7.53554L16.3536 4.35355ZM-4.37114e-08 4.5L16 4.5L16 3.5L4.37114e-08 3.5L-4.37114e-08 4.5Z" fill="#5E5E5E"/>
          </svg>
          <span>Wishlist</span>
        </div>
      </div>
      <div class="cs_height_80 cs_height_lg_60"></div>
    </div>
  </section>
  <!-- End Cart Page Heading -->

  <!-- Start Wishlist -->
  <div class="container">
    <div class="table-responsive">
      <table class="cs_cart_table cs_size1">
        <thead>
          <tr>
            <th>Product</th>
            <th>Price</th>
            <th>Stock Status</th>
            <th>Remove</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% if (wishlist && wishlist.length > 0) { %>
            <% wishlist.forEach(product => { %>
              <tr>
                <td>
                  <div class="cs_cart_table_media">
                    <!-- First product image -->
                    <img src="/uploads/products/<%= product.productImage[0] %>" alt="Thumb">
                     <a href="/product/<%= product._id %>">
                    <h3><%= product.productName %></h3>
                    </a>
                      <% if (product.status.toLowerCase() === "blocked") { %>
        <span class="badge bg-danger">Blocked</span>
      <% } else { %>
        <a href="#" class="cs_wishlist_btn" data-product-id="<%= product._id %>">
          <i class="fa-regular fa-heart"></i>
        </a>
      <% } %>
                  </div>
                </td>
                <td>â‚¹<%= (product.regularPrice || product.price || 0).toLocaleString() %></td>
                <td>
                  <% if (product.totalStock > 0 && product.status === "Available") { %>
                    In stock
                  <% } else { %>
                    Out of stock
                  <% } %>
                </td>
                <td class="text-center">
  <button 
    class="cs_cart-table-close btn-remove" 
    data-product-id="<%= product._id %>">
    <i class="fa-solid fa-xmark"></i>
  </button>
</td>
<td class="text-end">
  <% if (product.totalStock > 0 && product.status === "Available") { %>
   <button 
  class="cs_btn cs_style_1 cs_type_1 cs_fs_16 cs_medium btn-add-cart" 
  data-product-id="<%= product._id %>" 
  data-product-name="<%= product.productName %>"
  data-stock='<%= JSON.stringify(product.stock) %>'>
  Add to Cart
</button>

  <% } else { %>
    <span class="text-muted">Unavailable</span>
  <% } %>
</td>

              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="5" class="text-center">Your wishlist is empty.</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
  <!-- End Wishlist -->

  <div class="cs_height_140 cs_height_lg_80"></div>
  <hr>

<style>
  .size-option {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 80px;
    min-height: 80px;
    padding: 15px;
    margin: 5px;
    border: 2px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s ease;
    background-color: white;
  }
  
  .size-option:hover:not(.out-of-stock) {
    border-color: #3085d6;
    background-color: #f0f8ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .size-option.selected {
    border-color: #3085d6;
    background-color: #3085d6;
    color: white;
  }
  
  .size-option.out-of-stock {
    opacity: 0.4;
    cursor: not-allowed;
    background-color: #f5f5f5;
  }
  
  .size-label {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 5px;
  }
  
  .size-stock {
    font-size: 11px;
    color: #666;
    margin-top: 5px;
  }
  
  .size-option.selected .size-stock {
    color: white;
  }
  
  .size-option.out-of-stock .size-stock {
    color: #999;
  }
  
  .size-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
    padding: 10px;
  }
</style>

<script>
   document.addEventListener("DOMContentLoaded", () => {
  // Handle remove from wishlist
  document.querySelectorAll(".btn-remove").forEach(button => {
    button.addEventListener("click", async (e) => {
      e.preventDefault();
      const productId = button.getAttribute("data-product-id");

      Swal.fire({
        title: "Remove from wishlist?",
        text: "This product will be removed from your wishlist.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Yes, remove it!"
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const res = await fetch(`/wishlist/remove/${productId}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" }
            });

            const data = await res.json();

            if (data.success) {
              Swal.fire("Removed!", data.message, "success").then(() => {
                location.reload();
              });
            } else {
              Swal.fire("Error", data.message || "Could not remove", "error");
            }
          } catch (err) {
            Swal.fire("Error", "Something went wrong!", "error");
          }
        }
      });
    });
  });

  // Handle add to cart with size selection
  document.querySelectorAll(".btn-add-cart").forEach(button => {
    button.addEventListener("click", async (e) => {
      e.preventDefault();
      const productId = button.getAttribute("data-product-id");
      const productName = button.getAttribute("data-product-name");
      const stockData = JSON.parse(button.getAttribute("data-stock"));

      // Create size selection HTML
      let sizeOptionsHtml = '<div class="size-container">';
      stockData.forEach(item => {
        const isAvailable = item.quantity > 0;
        const disabledClass = isAvailable ? '' : 'out-of-stock';
        const stockText = isAvailable ? `${item.quantity} in stock` : 'Out of stock';
        
        sizeOptionsHtml += `
          <div class="size-option ${disabledClass}" 
               data-size="${item.size}" 
               data-available="${isAvailable}">
            <div class="size-label">${item.size}</div>
            <div class="size-stock">${stockText}</div>
          </div>
        `;
      });
      sizeOptionsHtml += '</div>';

      // Variable to store selected size
      let selectedSize = null;

      // Show size selection popup
      const result = await Swal.fire({
        title: `Select Size for ${productName}`,
        html: sizeOptionsHtml,
        showCancelButton: true,
        confirmButtonText: "Add to Cart",
        cancelButtonText: "Cancel",
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#aaa",
        allowOutsideClick: false,
        didOpen: () => {
          // Add click handlers to size options
          document.querySelectorAll('.size-option').forEach(option => {
            if (option.getAttribute('data-available') === 'true') {
              option.addEventListener('click', () => {
                // Remove previous selection
                document.querySelectorAll('.size-option').forEach(opt => {
                  opt.classList.remove('selected');
                });
                // Add selection to clicked option
                option.classList.add('selected');
                selectedSize = option.getAttribute('data-size');
              });
            }
          });
        },
        preConfirm: () => {
          if (!selectedSize) {
            Swal.showValidationMessage('Please select a size');
            return false;
          }
          return selectedSize;
        }
      });

      // If user confirmed and selected a size
      if (result.isConfirmed && result.value) {
        try {
          const res = await fetch(`/wishlist/addToCart/${productId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              size: result.value, 
              quantity: 1
            })
          });

          const data = await res.json();

          if (data.success) {
            Swal.fire("Added!", data.message, "success");
            updateCartBadge();

            // Remove wishlist row dynamically
            const row = button.closest("tr");
            if (row) {
              row.remove();
            }

            // If wishlist becomes empty, show message
            const tableBody = document.querySelector("tbody");
            if (tableBody && tableBody.children.length === 0) {
              tableBody.innerHTML = `
                <tr>
                  <td colspan="5" class="text-center">Your wishlist is empty.</td>
                </tr>`;
            }
          } else {
            Swal.fire("Error", data.message || "Could not add", "error");
          }
        } catch (err) {
          Swal.fire("Error", "Something went wrong!", "error");
        }
      }
    });
  });
});
</script>
  <%- include("../partials/user/footer") %>
  
</body>
</html>