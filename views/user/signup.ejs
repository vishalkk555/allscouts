<%- include("../partials/user/header") %>

<style>
  .error-message {
    color: red;
    font-size: 0.8rem;
    margin-top: 4px;
  }
  .error-border {
    border: 1px solid red;
  }
</style>

<div class="signup-wrapper">
  <div class="card">
    <h2>Create Account</h2>

    <% if (message) { %>
      <p class="error"><%= message %></p>
    <% } %>

    <form id="signupForm" novalidate>
      <div class="form-group">
        <label for="name">Name</label>
        <input type="text" name="name" id="name" value="<%= data?.name || '' %>" required />
        <small class="error-message"></small>
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" name="email" id="email" value="<%= data?.email || '' %>" required />
        <small class="error-message"></small>
      </div>

      <div class="form-group">
        <label for="phone">Phone Number</label>
        <input type="tel" name="phone" id="phone" pattern="[0-9]{10}" maxlength="10" value="<%= data?.phone || '' %>" required />
        <small class="error-message"></small>
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" name="password" id="password" required />
        <small class="error-message"></small>
      </div>

      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <input type="password" name="confirmPassword" id="confirmPassword" required />
        <small class="error-message"></small>
      </div>

      <div class="form-group">
        <label for="referralCode">Referral Code (Optional)</label>
        <input type="text" name="referralCode" id="referralCode" value="<%= data?.referralCode || '' %>" />
        <small class="error-message"></small>
      </div>

      <% if (locals.message && message.length > 0) { %>
        <div class="alert alert-danger text-center"><%= message %></div>
      <% } %>

      <button type="submit" class="btn">Sign Up</button>
    </form>

    <div class="signin-link">
      Already have an account? <a href="/login">Sign In</a>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const nameInput = document.getElementById('name');
  const emailInput = document.getElementById('email');
  const phoneInput = document.getElementById('phone');
  const passwordInput = document.getElementById('password');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const referralCodeInput = document.getElementById('referralCode');
  const form = document.getElementById('signupForm');

  const passwordPattern = /^(?=.*[A-Z])(?=.*\d).{8,}$/;
  const namePattern = /^[A-Za-z]+$/;
  const phonePattern = /^[6-9]\d{9}$/;
  const referralCodePattern = /^[A-Za-z0-9]{6}$/;

  nameInput.addEventListener('blur', () => validateName(nameInput));
  emailInput.addEventListener('blur', () => validateEmailField(emailInput));
  phoneInput.addEventListener('blur', () => validatePhone(phoneInput));
  passwordInput.addEventListener('blur', () => validatePassword(passwordInput));
  confirmPasswordInput.addEventListener('blur', () => validateConfirmPassword(confirmPasswordInput, passwordInput));
  referralCodeInput.addEventListener('blur', () => validateReferralCode(referralCodeInput));

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    let valid = true;

    if (!validateName(nameInput)) valid = false;
    if (!validateEmailField(emailInput)) valid = false;
    if (!validatePhone(phoneInput)) valid = false;
    if (!validatePassword(passwordInput)) valid = false;
    if (!validateConfirmPassword(confirmPasswordInput, passwordInput)) valid = false;
    if (!validateReferralCode(referralCodeInput)) valid = false;

    if (!valid) return;

    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    try {
      const response = await fetch('/signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await response.json();

      if (result.success) {
        window.location.href = result.redirectUrl || '/otp';
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Signup Failed',
          text: result.message || 'An error occurred',
          confirmButtonColor: '#d33'
        });
      }
    } catch (error) {
      console.error('Signup error:', error);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'An error occurred during signup',
        confirmButtonColor: '#d33'
      });
    }
  });

  function validateName(input) {
    if (!namePattern.test(input.value.trim())) {
      setError(input, 'Only alphabets allowed without spaces or symbols');
      return false;
    }
    clearError(input);
    return true;
  }

  function validateEmailField(input) {
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input.value)) {
      setError(input, 'Enter a valid email');
      return false;
    }
    clearError(input);
    return true;
  }

  function validatePhone(input) {
    const value = input.value.trim();
    if (!phonePattern.test(value)) {
      setError(input, 'Phone must start with 6-9 and be 10 digits');
      return false;
    }
    if (/^(\d)\1{9}$/.test(value)) {
      setError(input, 'Phone number cannot be all same digits');
      return false;
    }
    clearError(input);
    return true;
  }

  function validatePassword(input) {
    if (!passwordPattern.test(input.value)) {
      setError(input, 'Password: min 8 chars, 1 uppercase, 1 number');
      return false;
    }
    clearError(input);
    return true;
  }

  function validateConfirmPassword(input, passwordInput) {
    if (input.value !== passwordInput.value) {
      setError(input, 'Passwords do not match');
      return false;
    }
    clearError(input);
    return true;
  }

  function validateReferralCode(input) {
    const value = input.value.trim();
    if (value && !referralCodePattern.test(value)) {
      setError(input, 'Referral code must be 6 alphanumeric characters');
      return false;
    }
    clearError(input);
    return true;
  }

  function setError(input, message) {
    input.classList.add('error-border');
    input.nextElementSibling.textContent = message;
  }

  function clearError(input) {
    input.classList.remove('error-border');
    input.nextElementSibling.textContent = '';
  }
</script>

<%- include("../partials/user/footer") %>