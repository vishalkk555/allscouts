
<body>
    <%- include("../partials/admin/header") %> 


    <div class="add-coupon-container">
        <div class="add-coupon-header">
    <div class="header-text">
      <h1 class="title">Add Coupon</h1>
      <p class="subtitle">Create a new coupon for your customers</p>
    </div>
  </div>

        <div class="add-coupon-card">
            <form id="addCouponForm">
                <div class="form-grid">
                    <!-- Coupon Code -->
                    <div class="form-group">
                        <label for="couponCode" class="form-label">
                            Coupon Code <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="couponCode" 
                            name="couponCode" 
                            class="form-input" 
                            placeholder="e.g., SAVE20"
                            required
                        >
                        <span class="error-message" id="couponCodeError"></span>
                    </div>

                    <!-- Discount Type -->
                    <div class="form-group">
                        <label for="discountType" class="form-label">
                            Discount Type <span class="required">*</span>
                        </label>
                        <select id="discountType" name="type" class="form-select" required>
                            <option value="">Select Type</option>
                            <option value="flatDiscount">Fixed Amount</option>
                            <option value="percentageDiscount">Percentage</option>
                        </select>
                        <span class="error-message" id="discountTypeError"></span>
                    </div>

                    <!-- Discount Value -->
                    <div class="form-group">
                        <label for="discountValue" class="form-label">
                            Discount Value <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <span class="input-icon" id="discountIcon">₹</span>
                            <input 
                                type="number" 
                                id="discountValue" 
                                name="discount" 
                                class="form-input with-icon" 
                                placeholder="Enter discount value"
                                min="0"
                                step="0.01"
                                required
                            >
                        </div>
                        <span class="error-message" id="discountValueError"></span>
                    </div>

                    <!-- Status -->
                    <div class="form-group">
  <label for="status" class="form-label">Status</label>
  <input 
    type="text" 
    id="status" 
    name="status" 
    value="Active" 
    class="form-control" 
    readonly
  >
  <input type="hidden" name="status" value="true">
</div>


                    <!-- Min Purchase Amount -->
                    <div class="form-group">
                        <label for="minPurchase" class="form-label">
                            Min Purchase Amount <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <span class="input-icon">₹</span>
                            <input 
                                type="number" 
                                id="minPurchase" 
                                name="minPurchase" 
                                class="form-input with-icon" 
                                placeholder="Minimum purchase amount"
                                min="0"
                                step="0.01"
                                required
                            >
                        </div>
                        <span class="error-message" id="minPurchaseError"></span>
                    </div>

                   <!-- Max Redeem (only for percentage) -->
<div class="form-group" id="maxRedeemGroup">
    <label for="maxRedeem" class="form-label">
        Max Discount Cap (₹) <span class="required">*</span>
    </label>
    <div class="input-with-icon">
        <span class="input-icon">₹</span>
        <input 
            type="number" 
            id="maxRedeem" 
            name="maxRedeem" 
            class="form-input with-icon" 
            placeholder="e.g., 500"
            min="1"
            step="0.01"
            required
        >
    </div>
    <span class="error-message" id="maxRedeemError"></span>
    <small class="text-muted">Maximum discount amount user can receive (for percentage coupons)</small>
</div>

                    <!-- Expiry Date -->
                    <div class="form-group">
                        <label for="expiry" class="form-label">
                            Expiry Date <span class="required">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="expiry" 
                            name="expiry" 
                            class="form-input" 
                            required
                        >
                        <span class="error-message" id="expiryError"></span>
                    </div>

                    <!-- Description (Full Width) -->
                    <div class="form-group full-width">
                        <label for="description" class="form-label">
                            Description <span class="optional">(Optional)</span>
                        </label>
                        <textarea 
                            id="description" 
                            name="description" 
                            class="form-textarea" 
                            placeholder="Enter coupon description"
                            rows="4"
                        ></textarea>
                        <span class="error-message" id="descriptionError"></span>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-save">Save Coupon</button>
                </div>
            </form>
        </div>
    </div>

    
   <script>
document.addEventListener('DOMContentLoaded', function () {
    const form               = document.getElementById('addCouponForm');
    const discountTypeSelect = document.getElementById('discountType');
    const discountValueInput = document.getElementById('discountValue');
    const discountIcon       = document.getElementById('discountIcon');
    const maxRedeemGroup     = document.getElementById('maxRedeemGroup');
    const maxRedeemInput     = document.getElementById('maxRedeem');
    const cancelBtn          = document.getElementById('cancelBtn');
    const expiryInput        = document.getElementById('expiry');

    const today = new Date().toISOString().split('T')[0];
    expiryInput.setAttribute('min', today);
    toggleFields();                     // hide/show maxRedeem on page load
    discountTypeSelect.addEventListener('change', toggleFields);

    function toggleFields() {
        const type = discountTypeSelect.value;

        if (type === 'percentageDiscount') {
            maxRedeemGroup.style.display = 'block';
            maxRedeemInput.setAttribute('required', 'required');
            discountIcon.textContent = '%';
            discountValueInput.setAttribute('max', '100');
            discountValueInput.setAttribute('min', '0.01');
            discountValueInput.placeholder = 'Enter % (0.01-100)';
        } else if (type === 'flatDiscount') {
            maxRedeemGroup.style.display = 'none';
            maxRedeemInput.removeAttribute('required');
            maxRedeemInput.value = '';
            clearError('maxRedeem');
            discountIcon.textContent = '₹';
            discountValueInput.removeAttribute('max');
            discountValueInput.setAttribute('min', '0.01');
            discountValueInput.placeholder = 'Enter fixed amount';
        } else {
            maxRedeemGroup.style.display = 'none';
            discountIcon.textContent = '₹';
            discountValueInput.removeAttribute('max');
        }

        // reset discount value when type changes
        discountValueInput.value = '';
        clearError('discountValue');
    }

    /* ----------  VALIDATION HELPERS ---------- */
    function showError(id, msg) {
        const errEl = document.getElementById(id + 'Error');
        const inpEl = document.getElementById(id);
        if (errEl) errEl.textContent = msg;
        if (inpEl) inpEl.style.borderColor = '#e74c3c';
    }

    function clearError(id) {
        const errEl = document.getElementById(id + 'Error');
        const inpEl = document.getElementById(id);
        if (errEl) errEl.textContent = '';
        if (inpEl) inpEl.style.borderColor = '#dfe6e9';
    }

    function clearAllErrors() {
        document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
        document.querySelectorAll('.form-input, .form-select, .form-textarea')
                .forEach(el => el.style.borderColor = '#dfe6e9');
    }

    /* ---------- REAL-TIME CLEAR ERRORS ---------- */
    ['couponCode','discountType','discountValue','minPurchase','maxRedeem','expiry','description']
        .forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input',  () => clearError(id));
                el.addEventListener('change', () => clearError(id));
            }
        });

  
    function validateForm() {
        let ok = true;
        clearAllErrors();

        /* ---- Coupon Code ---- */
        const code = document.getElementById('couponCode').value.trim();
        if (!code) { showError('couponCode', 'Coupon code is required'); ok = false; }
        else if (code.length < 3) { showError('couponCode', 'At least 3 characters'); ok = false; }
        else if (!/^[A-Z0-9]+$/.test(code)) { showError('couponCode', 'Only uppercase letters & numbers'); ok = false; }

        /* ---- Discount Type ---- */
        const type = discountTypeSelect.value;
        if (!type) { showError('discountType', 'Select a discount type'); ok = false; }

        /* ---- Discount Value ---- */
        const disc = parseFloat(discountValueInput.value);
        if (isNaN(disc) || disc <= 0) { showError('discountValue', 'Discount must be > 0'); ok = false; }
        else if (type === 'percentageDiscount' && disc > 100) { showError('discountValue', 'Percentage ≤ 100'); ok = false; }
        else if (type === 'percentageDiscount' && disc < 0.01) { showError('discountValue', 'Percentage ≥ 0.01'); ok = false; }
        else if (type === 'flatDiscount' && disc < 0.01) { showError('discountValue', 'Fixed amount ≥ 0.01'); ok = false; }

        /* ---- Min Purchase ---- */
        const minP = parseFloat(document.getElementById('minPurchase').value);
        if (isNaN(minP) || minP < 0) { showError('minPurchase', 'Min purchase ≥ 0'); ok = false; }


        if (type === 'flatDiscount' && !isNaN(disc) && !isNaN(minP) && disc > minP) {
            showError('discountValue', 'Fixed discount cannot exceed min purchase');
            ok = false;
        }

        /* ---- Max Redeem (only % coupons) ---- */
        if (type === 'percentageDiscount') {
            const maxR = parseFloat(maxRedeemInput.value);
            if (isNaN(maxR) || maxR <= 0) { showError('maxRedeem', 'Max discount cap > 0'); ok = false; }
            // optional: maxR should be ≥ possible discount on min purchase
            const possible = (minP * disc) / 100;
            if (!isNaN(possible) && maxR < possible) {
                showError('maxRedeem', 'Max cap must be ≥ discount on min purchase');
                ok = false;
            }
        }

        /* ---- Expiry ---- */
        const exp = document.getElementById('expiry').value;
        if (!exp) { showError('expiry', 'Expiry date required'); ok = false; }
        else {
            const expDate = new Date(exp);
            const today   = new Date(); today.setHours(0,0,0,0);
            if (expDate < today) { showError('expiry', 'Expiry must be today or later'); ok = false; }
        }

     
        const desc = document.getElementById('description').value.trim();
        if (desc.length > 500) { showError('description', 'Description ≤ 500 chars'); ok = false; }

        return ok;
    }


    form.addEventListener('submit', async function (e) {
        e.preventDefault();

        if (!validateForm()) {
            // SweetAlert ONLY on submit when something is wrong
            Swal.fire({
                icon: 'error',
                title: 'Validation Error',
                text: 'Please fix the highlighted fields before submitting.',
                confirmButtonColor: '#e74c3c'
            });
            return;
        }

        const payload = {
            couponCode : document.getElementById('couponCode').value.trim().toUpperCase(),
            type       : discountTypeSelect.value,
            discount   : parseFloat(discountValueInput.value),
            status     : true,                     // always active
            minPurchase: parseFloat(document.getElementById('minPurchase').value),
            expiry     : document.getElementById('expiry').value,
            description: document.getElementById('description').value.trim()
        };

        // maxRedeem only for percentage coupons
        if (discountTypeSelect.value === 'percentageDiscount') {
            payload.maxRedeem = parseFloat(maxRedeemInput.value);
        }

        const submitBtn = form.querySelector('.btn-save');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';

        try {
            const res  = await fetch('/admin/coupons/addCoupon', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (res.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Coupon created successfully',
                    confirmButtonColor: '#27ae60'
                }).then(() => location.href = '/admin/coupons');
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to create coupon',
                    confirmButtonColor: '#e74c3c'
                });
            }
        } catch (err) {
            console.error(err);
            Swal.fire({
                icon: 'error',
                title: 'Network Error',
                text: 'Could not reach the server',
                confirmButtonColor: '#e74c3c'
            });
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Save Coupon';
        }
    });

  
    cancelBtn.addEventListener('click', () => {
        Swal.fire({
            title: 'Discard changes?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e74c3c',
            cancelButtonColor: '#95a5a6',
            confirmButtonText: 'Yes',
            cancelButtonText: 'No'
        }).then(r => { if (r.isConfirmed) location.href = '/admin/coupons'; });
    });

    /* ---------- COUPON CODE FORMAT ---------- */
    document.getElementById('couponCode').addEventListener('input', function () {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });
});
</script>
</body>
</html>