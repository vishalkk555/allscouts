

<body>
<%- include("../partials/admin/header") %> 

    <div class="add-coupon-container">
        <div class="add-coupon-header">
            <h1>Edit Coupon</h1>
            <p class="subtitle">Update coupon details</p>
        </div>

        <div class="add-coupon-card">
            <form id="editCouponForm">
                <input type="hidden" id="couponId" value="<%= coupon._id %>">
                
                <div class="form-grid">
                    <!-- Coupon Code -->
                    <div class="form-group">
                        <label for="couponCode" class="form-label">
                            Coupon Code <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="couponCode" 
                            name="couponCode" 
                            class="form-input" 
                            placeholder="e.g., SAVE20"
                            value="<%= coupon.couponCode %>"
                            required
                        >
                        <span class="error-message" id="couponCodeError"></span>
                    </div>

                    <!-- Discount Type -->
                    <div class="form-group">
                        <label for="discountType" class="form-label">
                            Discount Type <span class="required">*</span>
                        </label>
                        <select id="discountType" name="type" class="form-select" required>
                            <option value="">Select Type</option>
                            <option value="flatDiscount" <%= coupon.type === 'flatDiscount' ? 'selected' : '' %>>Fixed Amount</option>
                            <option value="percentageDiscount" <%= coupon.type === 'percentageDiscount' ? 'selected' : '' %>>Percentage</option>
                        </select>
                        <span class="error-message" id="discountTypeError"></span>
                    </div>

                    <!-- Discount Value -->
                    <div class="form-group">
                        <label for="discountValue" class="form-label">
                            Discount Value <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <span class="input-icon" id="discountIcon">
                                <%= coupon.type === 'percentageDiscount' ? '%' : '₹' %>
                            </span>
                            <input 
                                type="number" 
                                id="discountValue" 
                                name="discount" 
                                class="form-input with-icon" 
                                placeholder="Enter discount value"
                                min="0"
                                step="0.01"
                                value="<%= coupon.discount %>"
                                <% if (coupon.type === 'percentageDiscount') { %>max="100"<% } %>
                                required
                            >
                        </div>
                        <span class="error-message" id="discountValueError"></span>
                    </div>

                    <!-- Status -->
                    <div class="form-group">
                        <label for="status" class="form-label">
                            Status <span class="required">*</span>
                        </label>
                        <select id="status" name="status" class="form-select" required>
                            <option value="true" <%= coupon.status === true ? 'selected' : '' %>>Active</option>
                            <option value="false" <%= coupon.status === false ? 'selected' : '' %>>Inactive</option>
                        </select>
                        <span class="error-message" id="statusError"></span>
                    </div>

                    <!-- Min Purchase Amount -->
                    <div class="form-group">
                        <label for="minPurchase" class="form-label">
                            Min Purchase Amount <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <span class="input-icon">₹</span>
                            <input 
                                type="number" 
                                id="minPurchase" 
                                name="minPurchase" 
                                class="form-input with-icon" 
                                placeholder="Minimum purchase amount"
                                min="0"
                                step="0.01"
                                value="<%= coupon.minPurchase %>"
                                required
                            >
                        </div>
                        <span class="error-message" id="minPurchaseError"></span>
                    </div>

                   <!-- Max Redemption (only for percentage) -->
<div class="form-group" id="maxRedeemGroup" style="display: none;">
    <label for="maxRedeem" class="form-label">
        Max Discount Cap (₹) <span class="required">*</span>
    </label>
    <div class="input-with-icon">
        <span class="input-icon">₹</span>
        <input 
            type="number" 
            id="maxRedeem" 
            name="maxRedeem" 
            class="form-input with-icon" 
            placeholder="e.g., 500"
            min="0.01"
            step="0.01"
            value="<%= coupon.maxRedeem %>"
        >
    </div>
    <span class="error-message" id="maxRedeemError"></span>
    <small class="text-muted">Maximum discount amount user can receive (for percentage coupons)</small>
</div>

                    <!-- Expiry Date -->
                    <div class="form-group">
                        <label for="expiry" class="form-label">
                            Expiry Date <span class="required">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="expiry" 
                            name="expiry" 
                            class="form-input"
                            value="<%= new Date(coupon.expiry).toISOString().split('T')[0] %>"
                            required
                        >
                        <span class="error-message" id="expiryError"></span>
                    </div>

                    <!-- Description (Full Width) -->
                    <div class="form-group full-width">
                        <label for="description" class="form-label">
                            Description <span class="optional">(Optional)</span>
                        </label>
                        <textarea 
                            id="description" 
                            name="description" 
                            class="form-textarea" 
                            placeholder="Enter coupon description"
                            rows="4"
                        ><%= coupon.description || '' %></textarea>
                        <span class="error-message" id="descriptionError"></span>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-save">Update Coupon</button>
                </div>
            </form>
        </div>
    </div>

    
 <script>
document.addEventListener('DOMContentLoaded', function () {
    const form               = document.getElementById('editCouponForm');
    const discountTypeSelect = document.getElementById('discountType');
    const discountValueInput = document.getElementById('discountValue');
    const discountIcon       = document.getElementById('discountIcon');
    const maxRedeemGroup     = document.getElementById('maxRedeemGroup');
    const maxRedeemInput     = document.getElementById('maxRedeem');
    const statusSelect       = document.getElementById('status');
    const cancelBtn          = document.getElementById('cancelBtn');
    const expiryInput        = document.getElementById('expiry');
    const couponId           = document.getElementById('couponId').value;

    /* ---------- 1. INITIAL SETUP ---------- */
    const today = new Date().toISOString().split('T')[0];
    expiryInput.setAttribute('min', today);

    // DO NOT call toggleMaxRedeemField() here — it clears discount value
    // Just set icon & maxRedeem visibility based on current type
    initializeFields();

    // Only toggle on user change
    discountTypeSelect.addEventListener('change', toggleMaxRedeemField);

    /* ---------- INITIALIZE (run once on load) ---------- */
    function initializeFields() {
        const type = discountTypeSelect.value;

        // Set icon
        discountIcon.textContent = type === 'percentageDiscount' ? '%' : '₹';

        // Set min/max attributes
        if (type === 'percentageDiscount') {
            discountValueInput.setAttribute('max', '99.99');
            discountValueInput.setAttribute('min', '0.01');
        } else {
            discountValueInput.removeAttribute('max');
            discountValueInput.setAttribute('min', '0.01');
        }

        // Show/hide maxRedeem
        if (type === 'percentageDiscount') {
            maxRedeemGroup.style.display = 'block';
            maxRedeemInput.setAttribute('required', 'required');
        } else {
            maxRedeemGroup.style.display = 'none';
            maxRedeemInput.removeAttribute('required');
        }

        // DO NOT clear discountValueInput.value here!
    }

    /* ---------- TOGGLE ON USER CHANGE ---------- */
    function toggleMaxRedeemField() {
        const type = discountTypeSelect.value;

        discountIcon.textContent = type === 'percentageDiscount' ? '%' : '₹';

        if (type === 'percentageDiscount') {
            maxRedeemGroup.style.display = 'block';
            maxRedeemInput.setAttribute('required', 'required');
            discountValueInput.setAttribute('max', '99.99');
            discountValueInput.setAttribute('min', '0.01');
            discountValueInput.placeholder = 'Enter % (0.01 - 99.99)';
        } else {
            maxRedeemGroup.style.display = 'none';
            maxRedeemInput.removeAttribute('required');
            discountValueInput.removeAttribute('max');
            discountValueInput.setAttribute('min', '0.01');
            discountValueInput.placeholder = 'Enter fixed amount';
        }

        // Only clear discount value when user *changes* type
        discountValueInput.value = '';
        clearError('discountValue');
    }

    /* ---------- REST OF YOUR CODE (unchanged) ---------- */
    // ... [showError, clearError, validateForm, submit, cancel, etc.] ...
    // (Copy the rest from the previous working version)

    // Keep all validation, submit, etc. exactly as before
    // Just make sure `initializeFields()` is called instead of `toggleMaxRedeemField()`

    function showError(id, msg) {
        const errEl = document.getElementById(id + 'Error');
        const inpEl = document.getElementById(id);
        if (errEl) errEl.textContent = msg;
        if (inpEl) inpEl.style.borderColor = '#e74c3c';
    }

    function clearError(id) {
        const errEl = document.getElementById(id + 'Error');
        const inpEl = document.getElementById(id);
        if (errEl) errEl.textContent = '';
        if (inpEl) inpEl.style.borderColor = '#dfe6e9';
    }

    function clearAllErrors() {
        document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
        document.querySelectorAll('.form-input, .form-select, .form-textarea')
                .forEach(el => el.style.borderColor = '#dfe6e9');
    }

    ['couponCode','discountType','discountValue','minPurchase','maxRedeem','expiry','description','status']
        .forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input',  () => clearError(id));
                el.addEventListener('change', () => clearError(id));
            }
        });

    function validateForm() {
        let ok = true;
        clearAllErrors();

        const code = document.getElementById('couponCode').value.trim();
        if (!code) { showError('couponCode', 'Coupon code is required'); ok = false; }
        else if (code.length < 3) { showError('couponCode', 'At least 3 characters'); ok = false; }
        else if (!/^[A-Z0-9]+$/.test(code)) { showError('couponCode', 'Only uppercase letters & numbers'); ok = false; }

        const type = discountTypeSelect.value;
        if (!type) { showError('discountType', 'Select a discount type'); ok = false; }

        const disc = parseFloat(discountValueInput.value);
        if (isNaN(disc) || disc <= 0) { showError('discountValue', 'Discount must be > 0'); ok = false; }
        else if (type === 'percentageDiscount') {
            if (disc >= 100) { showError('discountValue', 'Percentage must be < 100%'); ok = false; }
            if (disc <= 0) { showError('discountValue', 'Percentage must be > 0%'); ok = false; }
        } else if (type === 'flatDiscount') {
            if (disc <= 0) { showError('discountValue', 'Fixed discount must be > 0'); ok = false; }
        }

        const minP = parseFloat(document.getElementById('minPurchase').value);
        if (isNaN(minP) || minP < 0) { showError('minPurchase', 'Min purchase ≥ 0'); ok = false; }

        if (type === 'flatDiscount' && !isNaN(disc) && !isNaN(minP) && disc > minP) {
            showError('discountValue', 'Fixed discount cannot exceed min purchase');
            ok = false;
        }

        if (type === 'percentageDiscount') {
            const maxR = parseFloat(maxRedeemInput.value);
            if (isNaN(maxR) || maxR <= 0) { showError('maxRedeem', 'Max discount cap > 0'); ok = false; }
            const possible = (minP * disc) / 100;
            if (!isNaN(possible) && maxR < possible) {
                showError('maxRedeem', 'Max cap must be ≥ discount on min purchase');
                ok = false;
            }
        }

        const exp = document.getElementById('expiry').value;
        if (!exp) { showError('expiry', 'Expiry date required'); ok = false; }
        else {
            const expDate = new Date(exp);
            const today   = new Date(); today.setHours(0,0,0,0);
            if (expDate < today) { showError('expiry', 'Expiry must be today or later'); ok = false; }
        }

        const desc = document.getElementById('description').value.trim();
        if (desc.length > 500) { showError('description', 'Description ≤ 500 chars'); ok = false; }

        return ok;
    }

    form.addEventListener('submit', async function (e) {
        e.preventDefault();
        if (!validateForm()) {
            Swal.fire({
                icon: 'error',
                title: 'Validation Error',
                text: 'Please fix the highlighted fields before submitting.',
                confirmButtonColor: '#e74c3c'
            });
            return;
        }

        const payload = {
            couponCode : document.getElementById('couponCode').value.trim().toUpperCase(),
            type       : discountTypeSelect.value,
            discount   : parseFloat(discountValueInput.value),
            status     : statusSelect.value === 'true',
            minPurchase: parseFloat(document.getElementById('minPurchase').value),
            expiry     : document.getElementById('expiry').value,
            description: document.getElementById('description').value.trim()
        };

        if (discountTypeSelect.value === 'percentageDiscount') {
            payload.maxRedeem = parseFloat(maxRedeemInput.value);
        }

        const submitBtn = form.querySelector('.btn-save');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Updating...';

        try {
            const res  = await fetch(`/admin/coupons/edit/${couponId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (res.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Coupon updated successfully',
                    confirmButtonColor: '#27ae60'
                }).then(() => location.href = '/admin/coupons');
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to update coupon',
                    confirmButtonColor: '#e74c3c'
                });
            }
        } catch (err) {
            console.error(err);
            Swal.fire({
                icon: 'error',
                title: 'Network Error',
                text: 'Could not reach the server',
                confirmButtonColor: '#e74c3c'
            });
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Update Coupon';
        }
    });

    cancelBtn.addEventListener('click', () => {
        Swal.fire({
            title: 'Discard changes?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e74c3c',
            cancelButtonColor: '#95a5a6',
            confirmButtonText: 'Yes',
            cancelButtonText: 'No'
        }).then(r => { if (r.isConfirmed) location.href = '/admin/coupons'; });
    });

    document.getElementById('couponCode').addEventListener('input', function () {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });
});
</script>
</body>
</html>