

<body>
<%- include("../partials/admin/header") %> 

    <div class="add-coupon-container">
        <div class="add-coupon-header">
            <h1>Edit Coupon</h1>
            <p class="subtitle">Update coupon details</p>
        </div>

        <div class="add-coupon-card">
            <form id="editCouponForm">
                <input type="hidden" id="couponId" value="<%= coupon._id %>">
                
                <div class="form-grid">
                    <!-- Coupon Code -->
                    <div class="form-group">
                        <label for="couponCode" class="form-label">
                            Coupon Code <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="couponCode" 
                            name="couponCode" 
                            class="form-input" 
                            placeholder="e.g., SAVE20"
                            value="<%= coupon.couponCode %>"
                            required
                        >
                        <span class="error-message" id="couponCodeError"></span>
                    </div>

                    <!-- Discount Type -->
                    <div class="form-group">
                        <label for="discountType" class="form-label">
                            Discount Type <span class="required">*</span>
                        </label>
                        <select id="discountType" name="type" class="form-select" required>
                            <option value="">Select Type</option>
                            <option value="flatDiscount" <%= coupon.type === 'flatDiscount' ? 'selected' : '' %>>Fixed Amount</option>
                            <option value="percentageDiscount" <%= coupon.type === 'percentageDiscount' ? 'selected' : '' %>>Percentage</option>
                        </select>
                        <span class="error-message" id="discountTypeError"></span>
                    </div>

                    <!-- Discount Value -->
                    <div class="form-group">
                        <label for="discountValue" class="form-label">
                            Discount Value <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <span class="input-icon" id="discountIcon">
                                <%= coupon.type === 'percentageDiscount' ? '%' : '₹' %>
                            </span>
                            <input 
                                type="number" 
                                id="discountValue" 
                                name="discount" 
                                class="form-input with-icon" 
                                placeholder="Enter discount value"
                                min="0"
                                step="0.01"
                                value="<%= coupon.discount %>"
                                <% if (coupon.type === 'percentageDiscount') { %>max="100"<% } %>
                                required
                            >
                        </div>
                        <span class="error-message" id="discountValueError"></span>
                    </div>

                    <!-- Status -->
                    <div class="form-group">
                        <label for="status" class="form-label">
                            Status <span class="required">*</span>
                        </label>
                        <select id="status" name="status" class="form-select" required>
                            <option value="true" <%= coupon.status === true ? 'selected' : '' %>>Active</option>
                            <option value="false" <%= coupon.status === false ? 'selected' : '' %>>Inactive</option>
                        </select>
                        <span class="error-message" id="statusError"></span>
                    </div>

                    <!-- Min Purchase Amount -->
                    <div class="form-group">
                        <label for="minPurchase" class="form-label">
                            Min Purchase Amount <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <span class="input-icon">₹</span>
                            <input 
                                type="number" 
                                id="minPurchase" 
                                name="minPurchase" 
                                class="form-input with-icon" 
                                placeholder="Minimum purchase amount"
                                min="0"
                                step="0.01"
                                value="<%= coupon.minPurchase %>"
                                required
                            >
                        </div>
                        <span class="error-message" id="minPurchaseError"></span>
                    </div>

                   <!-- Max Redemption (only for percentage) -->
<div class="form-group" id="maxRedeemGroup" style="display: none;">
    <label for="maxRedeem" class="form-label">
        Max Discount Cap (₹) <span class="required">*</span>
    </label>
    <div class="input-with-icon">
        <span class="input-icon">₹</span>
        <input 
            type="number" 
            id="maxRedeem" 
            name="maxRedeem" 
            class="form-input with-icon" 
            placeholder="e.g., 500"
            min="0.01"
            step="0.01"
            value="<%= coupon.maxRedeem %>"
        >
    </div>
    <span class="error-message" id="maxRedeemError"></span>
    <small class="text-muted">Maximum discount amount user can receive (for percentage coupons)</small>
</div>

                    <!-- Expiry Date -->
                    <div class="form-group">
                        <label for="expiry" class="form-label">
                            Expiry Date <span class="required">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="expiry" 
                            name="expiry" 
                            class="form-input"
                            value="<%= new Date(coupon.expiry).toISOString().split('T')[0] %>"
                            required
                        >
                        <span class="error-message" id="expiryError"></span>
                    </div>

                    <!-- Description (Full Width) -->
                    <div class="form-group full-width">
                        <label for="description" class="form-label">
                            Description <span class="optional">(Optional)</span>
                        </label>
                        <textarea 
                            id="description" 
                            name="description" 
                            class="form-textarea" 
                            placeholder="Enter coupon description"
                            rows="4"
                        ><%= coupon.description || '' %></textarea>
                        <span class="error-message" id="descriptionError"></span>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-save">Update Coupon</button>
                </div>
            </form>
        </div>
    </div>

    
 <script>
document.addEventListener('DOMContentLoaded', function () {
    const form               = document.getElementById('editCouponForm');
    const discountTypeSelect = document.getElementById('discountType');
    const discountValueInput = document.getElementById('discountValue');
    const discountIcon       = document.getElementById('discountIcon');
    const maxRedeemGroup     = document.getElementById('maxRedeemGroup');
    const maxRedeemInput     = document.getElementById('maxRedeem');
    const statusSelect       = document.getElementById('status');
    const cancelBtn          = document.getElementById('cancelBtn');
    const expiryInput        = document.getElementById('expiry');
    const couponCodeInput    = document.getElementById('couponCode');
    const minPurchaseInput   = document.getElementById('minPurchase');
    const descriptionInput   = document.getElementById('description');
    const couponId           = document.getElementById('couponId').value;

    /* ---------- 1. INITIAL SETUP ---------- */
    const today = new Date().toISOString().split('T')[0];
    expiryInput.setAttribute('min', today);

    // Initialize fields without clearing values
    initializeFields();

    // Only toggle on user change
    discountTypeSelect.addEventListener('change', toggleMaxRedeemField);

    /* ---------- INITIALIZE (run once on load) ---------- */
    function initializeFields() {
        const type = discountTypeSelect.value;

        // Set icon
        discountIcon.textContent = type === 'percentageDiscount' ? '%' : '₹';

        // Set min/max attributes
        if (type === 'percentageDiscount') {
            discountValueInput.setAttribute('max', '100');
            discountValueInput.setAttribute('min', '0.01');
            discountValueInput.placeholder = 'Enter % (0.01-100)';
        } else {
            discountValueInput.removeAttribute('max');
            discountValueInput.setAttribute('min', '0.01');
            discountValueInput.placeholder = 'Enter fixed amount';
        }

        // Show/hide maxRedeem
        if (type === 'percentageDiscount') {
            maxRedeemGroup.style.display = 'block';
            maxRedeemInput.setAttribute('required', 'required');
        } else {
            maxRedeemGroup.style.display = 'none';
            maxRedeemInput.removeAttribute('required');
        }
    }

    /* ---------- TOGGLE ON USER CHANGE ---------- */
    function toggleMaxRedeemField() {
        const type = discountTypeSelect.value;

        discountIcon.textContent = type === 'percentageDiscount' ? '%' : '₹';

        if (type === 'percentageDiscount') {
            maxRedeemGroup.style.display = 'block';
            maxRedeemInput.setAttribute('required', 'required');
            discountValueInput.setAttribute('max', '100');
            discountValueInput.setAttribute('min', '0.01');
            discountValueInput.placeholder = 'Enter % (0.01-100)';
        } else {
            maxRedeemGroup.style.display = 'none';
            maxRedeemInput.removeAttribute('required');
            maxRedeemInput.value = '';
            clearError('maxRedeem');
            discountValueInput.removeAttribute('max');
            discountValueInput.setAttribute('min', '0.01');
            discountValueInput.placeholder = 'Enter fixed amount';
        }

        // Clear discount value when user changes type
        discountValueInput.value = '';
        clearError('discountValue');
    }

    /* ----------  VALIDATION HELPERS ---------- */
    function showError(id, msg) {
        const errEl = document.getElementById(id + 'Error');
        const inpEl = document.getElementById(id);
        if (errEl) {
            errEl.textContent = msg;
            errEl.style.color = '#e74c3c';
            errEl.style.fontSize = '0.875rem';
            errEl.style.marginTop = '0.25rem';
            errEl.style.display = 'block';
        }
        if (inpEl) {
            inpEl.style.borderColor = '#e74c3c';
            inpEl.style.boxShadow = '0 0 0 3px rgba(231, 76, 60, 0.1)';
        }
    }

    function clearError(id) {
        const errEl = document.getElementById(id + 'Error');
        const inpEl = document.getElementById(id);
        if (errEl) {
            errEl.textContent = '';
            errEl.style.display = 'none';
        }
        if (inpEl) {
            inpEl.style.borderColor = '#dfe6e9';
            inpEl.style.boxShadow = 'none';
        }
    }

    function clearAllErrors() {
        document.querySelectorAll('.error-message').forEach(el => {
            el.textContent = '';
            el.style.display = 'none';
        });
        document.querySelectorAll('.form-input, .form-select, .form-textarea')
                .forEach(el => {
                    el.style.borderColor = '#dfe6e9';
                    el.style.boxShadow = 'none';
                });
    }

    /* ---------- REAL-TIME VALIDATION ---------- */
    
    // Coupon Code - Real-time validation
    couponCodeInput.addEventListener('input', function() {
        const code = this.value.trim();
        clearError('couponCode');
        
        if (code && code.length < 3) {
            showError('couponCode', 'Coupon code must be at least 3 characters');
        }
    });

    couponCodeInput.addEventListener('blur', function() {
        const code = this.value.trim();
        if (!code) {
            showError('couponCode', 'Coupon code is required');
        }
    });

    // Discount Type
    discountTypeSelect.addEventListener('change', function() {
        clearError('discountType');
        if (!this.value) {
            showError('discountType', 'Please select a discount type');
        }
        // Re-validate discount value when type changes
        if (discountValueInput.value) {
            setTimeout(validateDiscountValue, 100); // Small delay to let toggle complete
        }
    });

    // Discount Value - Real-time validation
    discountValueInput.addEventListener('input', validateDiscountValue);
    discountValueInput.addEventListener('blur', validateDiscountValue);

    function validateDiscountValue() {
        const disc = parseFloat(discountValueInput.value);
        const type = discountTypeSelect.value;
        const minP = parseFloat(minPurchaseInput.value);
        
        clearError('discountValue');

        if (discountValueInput.value && isNaN(disc)) {
            showError('discountValue', 'Please enter a valid number');
            return;
        }

        if (discountValueInput.value && disc <= 0) {
            showError('discountValue', 'Discount must be greater than 0');
            return;
        }

        if (type === 'percentageDiscount') {
            if (disc > 100) {
                showError('discountValue', 'Percentage cannot exceed 100%');
                return;
            }
            if (disc < 0.01) {
                showError('discountValue', 'Percentage must be at least 0.01%');
                return;
            }
        } else if (type === 'flatDiscount') {
            if (disc < 0.01) {
                showError('discountValue', 'Fixed amount must be at least ₹0.01');
                return;
            }
            if (!isNaN(minP) && minP > 0 && disc > minP) {
                showError('discountValue', 'Fixed discount cannot exceed minimum purchase amount');
                return;
            }
        }
    }

    // Min Purchase - Real-time validation
    minPurchaseInput.addEventListener('input', validateMinPurchase);
    minPurchaseInput.addEventListener('blur', validateMinPurchase);

    function validateMinPurchase() {
        const minP = parseFloat(minPurchaseInput.value);
        const disc = parseFloat(discountValueInput.value);
        const type = discountTypeSelect.value;
        
        clearError('minPurchase');

        if (minPurchaseInput.value && isNaN(minP)) {
            showError('minPurchase', 'Please enter a valid number');
            return;
        }

        if (minPurchaseInput.value && minP < 0) {
            showError('minPurchase', 'Minimum purchase cannot be negative');
            return;
        }

        // Re-validate discount if it's a flat discount
        if (type === 'flatDiscount' && !isNaN(disc) && disc > 0) {
            if (!isNaN(minP) && minP > 0 && disc > minP) {
                showError('minPurchase', 'Minimum purchase must be ≥ fixed discount amount');
            }
        }
    }

    // Max Redeem - Real-time validation
    maxRedeemInput.addEventListener('input', validateMaxRedeem);
    maxRedeemInput.addEventListener('blur', validateMaxRedeem);

    function validateMaxRedeem() {
        const type = discountTypeSelect.value;
        if (type !== 'percentageDiscount') return;

        const maxR = parseFloat(maxRedeemInput.value);
        const minP = parseFloat(minPurchaseInput.value);
        const disc = parseFloat(discountValueInput.value);
        
        clearError('maxRedeem');

        if (maxRedeemInput.value && isNaN(maxR)) {
            showError('maxRedeem', 'Please enter a valid number');
            return;
        }

        if (maxRedeemInput.value && maxR <= 0) {
            showError('maxRedeem', 'Max discount cap must be greater than 0');
            return;
        }

        // Check if max cap is reasonable based on min purchase
        if (!isNaN(maxR) && !isNaN(minP) && !isNaN(disc) && minP > 0 && disc > 0) {
            const possibleDiscount = (minP * disc) / 100;
            if (maxR < possibleDiscount) {
                showError('maxRedeem', `Max cap should be ≥ ₹${possibleDiscount.toFixed(2)} (discount on min purchase)`);
            }
        }
    }

    // Expiry Date - Real-time validation
    expiryInput.addEventListener('change', function() {
        clearError('expiry');
        
        if (!this.value) {
            showError('expiry', 'Expiry date is required');
            return;
        }

        const expDate = new Date(this.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (expDate < today) {
            showError('expiry', 'Expiry date must be today or in the future');
        }
    });

    // Description - Character count validation
    descriptionInput.addEventListener('input', function() {
        const len = this.value.trim().length;
        clearError('description');
        
        if (len > 500) {
            showError('description', `Description is too long (${len}/500 characters)`);
        }
    });

    // Status - Clear error on change
    statusSelect.addEventListener('change', function() {
        clearError('status');
    });

    /* ---------- FORM VALIDATION ---------- */
    function validateForm() {
        let ok = true;
        clearAllErrors();

        /* Coupon Code */
        const code = couponCodeInput.value.trim();
        if (!code) {
            showError('couponCode', 'Coupon code is required');
            ok = false;
        } else if (code.length < 3) {
            showError('couponCode', 'Coupon code must be at least 3 characters');
            ok = false;
        }

        /* Discount Type */
        const type = discountTypeSelect.value;
        if (!type) {
            showError('discountType', 'Please select a discount type');
            ok = false;
        }

        /* Discount Value */
        const disc = parseFloat(discountValueInput.value);
        if (isNaN(disc) || disc <= 0) {
            showError('discountValue', 'Discount must be greater than 0');
            ok = false;
        } else if (type === 'percentageDiscount') {
            if (disc > 100) {
                showError('discountValue', 'Percentage cannot exceed 100%');
                ok = false;
            } else if (disc < 0.01) {
                showError('discountValue', 'Percentage must be at least 0.01%');
                ok = false;
            }
        } else if (type === 'flatDiscount' && disc < 0.01) {
            showError('discountValue', 'Fixed amount must be at least ₹0.01');
            ok = false;
        }

        /* Min Purchase */
        const minP = parseFloat(minPurchaseInput.value);
        if (isNaN(minP) || minP < 0) {
            showError('minPurchase', 'Minimum purchase must be 0 or greater');
            ok = false;
        }

        /* Fixed discount cannot exceed min purchase */
        if (type === 'flatDiscount' && !isNaN(disc) && !isNaN(minP) && disc > minP) {
            showError('discountValue', 'Fixed discount cannot exceed minimum purchase amount');
            ok = false;
        }

        /* Max Redeem */
        if (type === 'percentageDiscount') {
            const maxR = parseFloat(maxRedeemInput.value);
            if (isNaN(maxR) || maxR <= 0) {
                showError('maxRedeem', 'Max discount cap is required and must be greater than 0');
                ok = false;
            } else {
                const possibleDiscount = (minP * disc) / 100;
                if (!isNaN(possibleDiscount) && maxR < possibleDiscount) {
                    showError('maxRedeem', `Max cap must be ≥ ₹${possibleDiscount.toFixed(2)} (discount on min purchase)`);
                    ok = false;
                }
            }
        }

        /* Expiry Date */
        const exp = expiryInput.value;
        if (!exp) {
            showError('expiry', 'Expiry date is required');
            ok = false;
        } else {
            const expDate = new Date(exp);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (expDate < today) {
                showError('expiry', 'Expiry date must be today or in the future');
                ok = false;
            }
        }

        /* Description */
        const desc = descriptionInput.value.trim();
        if (desc.length > 500) {
            showError('description', `Description is too long (${desc.length}/500 characters)`);
            ok = false;
        }

        /* Status */
        if (!statusSelect.value) {
            showError('status', 'Please select a status');
            ok = false;
        }

        return ok;
    }

    /* ---------- FORM SUBMISSION ---------- */
    form.addEventListener('submit', async function (e) {
        e.preventDefault();

        if (!validateForm()) {
            Swal.fire({
                icon: 'error',
                title: 'Validation Error',
                text: 'Please fix the errors highlighted in red before submitting.',
                confirmButtonColor: '#e74c3c'
            });
            // Scroll to first error
            const firstError = document.querySelector('.error-message:not(:empty)');
            if (firstError) {
                firstError.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        const payload = {
            couponCode: couponCodeInput.value.trim().toUpperCase(),
            type: discountTypeSelect.value,
            discount: parseFloat(discountValueInput.value),
            status: statusSelect.value === 'true',
            minPurchase: parseFloat(minPurchaseInput.value),
            expiry: expiryInput.value,
            description: descriptionInput.value.trim()
        };

        if (discountTypeSelect.value === 'percentageDiscount') {
            payload.maxRedeem = parseFloat(maxRedeemInput.value);
        }

        const submitBtn = form.querySelector('.btn-save');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Updating...';

        try {
            const res = await fetch(`/admin/coupons/edit/${couponId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (res.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Coupon updated successfully',
                    confirmButtonColor: '#27ae60'
                }).then(() => location.href = '/admin/coupons');
            } else {
                // Handle server-side validation errors
                if (data.message.includes('already exists')) {
                    showError('couponCode', 'This coupon code already exists');
                }
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to update coupon',
                    confirmButtonColor: '#e74c3c'
                });
            }
        } catch (err) {
            console.error(err);
            Swal.fire({
                icon: 'error',
                title: 'Network Error',
                text: 'Could not reach the server. Please try again.',
                confirmButtonColor: '#e74c3c'
            });
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Update Coupon';
        }
    });

    /* ---------- CANCEL BUTTON ---------- */
    cancelBtn.addEventListener('click', () => {
        Swal.fire({
            title: 'Discard changes?',
            text: 'All unsaved changes will be lost',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e74c3c',
            cancelButtonColor: '#95a5a6',
            confirmButtonText: 'Yes, discard',
            cancelButtonText: 'No, keep editing'
        }).then(r => {
            if (r.isConfirmed) location.href = '/admin/coupons';
        });
    });

    /* ---------- COUPON CODE FORMAT ---------- */
    couponCodeInput.addEventListener('input', function () {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });
});
</script>
</body>
</html>