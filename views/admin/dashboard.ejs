<%- include('../partials/admin/header') %>

<link rel="stylesheet" href="/css/admin/dashboard.css">

<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header">
        <h1>Dashboard</h1>
        <div class="header-controls">
            <div class="filter-section">
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="daily">Daily</button>
                    <button class="filter-btn" data-filter="weekly">Weekly</button>
                    <button class="filter-btn" data-filter="monthly">Monthly</button>
                    <button class="filter-btn" data-filter="yearly">Yearly</button>
                </div>
                <div class="date-filter-group">
                    <input type="date" id="fromDate" class="date-input" placeholder="From Date">
                    <input type="date" id="toDate" class="date-input" placeholder="To Date">
                    <button class="filter-btn" id="applyDateFilter">Apply</button>
                </div>
            </div>
            <div class="report-actions">
                <select id="reportFormatSelect" class="report-format-select">
                    <option value="pdf">PDF</option>
                    <option value="excel">Excel</option>
                </select>
                <button class="generate-report-btn" id="generateReportBtn">
                    <i class="fas fa-file-download"></i> Generate Sales Report
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card revenue-card">
            <div class="stat-icon">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-content">
                <h3>Total Revenue</h3>
                <p class="stat-value" id="totalRevenue">₹0</p>
                <span class="stat-change positive" id="revenueChange">+0%</span>
            </div>
        </div>

        <div class="stat-card orders-card">
            <div class="stat-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="stat-content">
                <h3>Total Orders</h3>
                <p class="stat-value" id="totalOrders">0</p>
                <span class="stat-change positive" id="ordersChange">+0%</span>
            </div>
        </div>

        <div class="stat-card products-card">
            <div class="stat-icon">
                <i class="fas fa-box"></i>
            </div>
            <div class="stat-content">
                <h3>Active Products</h3>
                <p class="stat-value" id="activeProducts">0</p>
                <span class="stat-change" id="productsChange">Total in stock</span>
            </div>
        </div>

        <div class="stat-card discount-card">
            <div class="stat-icon">
                <i class="fas fa-tags"></i>
            </div>
            <div class="stat-content">
                <h3>Total Discounts</h3>
                <p class="stat-value" id="totalDiscounts">₹0</p>
                <span class="stat-change" id="discountChange">Coupons applied</span>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="chart-container">
        <div class="chart-header">
            <h2>Orders Overview</h2>
            <div class="chart-period" id="chartPeriod">Last 7 Days</div>
        </div>
        <div class="chart-wrapper">
            <div class="chart-y-label">Number of Orders</div>
            <canvas id="ordersChart"></canvas>
        </div>
        <div class="chart-x-label">Time Period</div>
    </div>

    <!-- Sales Report Table -->
    <div class="report-section">
        <div class="report-header">
            <h2>Recent Orders</h2>
            <button class="view-all-btn" onclick="window.location.href='/admin/orders'">View All</button>
        </div>
        <div class="table-wrapper">
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Date</th>
                        <th>Customer Name</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="recentOrdersBody">
                    <tr>
                        <td colspan="5" class="loading-row">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div class="modal" id="reportModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Generate Sales Report</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Report Period</label>
                <input type="text" id="reportPeriodDisplay" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label>Download Format</label>
                <div class="format-options">
                    <label class="format-option">
                        <input type="radio" name="downloadFormat" value="pdf" checked>
                        <span class="format-label">
                            <i class="fas fa-file-pdf"></i> PDF
                        </span>
                    </label>
                    <label class="format-option">
                        <input type="radio" name="downloadFormat" value="excel">
                        <span class="format-label">
                            <i class="fas fa-file-excel"></i> Excel
                        </span>
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" id="cancelReport">Cancel</button>
            <button class="btn-primary" id="downloadReport">
                <i class="fas fa-download"></i> Download Report
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>

   // Dashboard JavaScript
let ordersChart;
let currentFilter = 'daily';
let customDateRange = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeChart();
    loadDashboardData('daily');
    setupEventListeners();
});

// Setup Event Listeners
function setupEventListeners() {
    // Filter buttons
    const filterBtns = document.querySelectorAll('.filter-btn[data-filter]');
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.filter;
            customDateRange = null;
            document.getElementById('fromDate').value = '';
            document.getElementById('toDate').value = '';
            loadDashboardData(currentFilter);
        });
    });

    // Custom date filter
    const applyDateFilter = document.getElementById('applyDateFilter');
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');

    applyDateFilter.addEventListener('click', function() {
        if (!fromDate.value || !toDate.value) {
            showNotification('Please select both from and to dates', 'error');
            return;
        }

        if (new Date(fromDate.value) > new Date(toDate.value)) {
            showNotification('From date cannot be after to date', 'error');
            return;
        }

        filterBtns.forEach(b => b.classList.remove('active'));
        customDateRange = {
            start: fromDate.value,
            end: toDate.value
        };
        currentFilter = 'custom';
        loadDashboardData('custom', customDateRange);
    });

    // Generate Report Modal
    const generateReportBtn = document.getElementById('generateReportBtn');
    const reportModal = document.getElementById('reportModal');
    const closeModal = document.querySelector('.close-modal');
    const cancelReport = document.getElementById('cancelReport');
    const downloadReport = document.getElementById('downloadReport');

    generateReportBtn.addEventListener('click', () => {
        openReportModal();
    });

    closeModal.addEventListener('click', () => {
        reportModal.classList.remove('show');
    });

    cancelReport.addEventListener('click', () => {
        reportModal.classList.remove('show');
    });

    reportModal.addEventListener('click', (e) => {
        if (e.target === reportModal) {
            reportModal.classList.remove('show');
        }
    });

    downloadReport.addEventListener('click', generateSalesReport);
}

// Open Report Modal
function openReportModal() {
    const reportModal = document.getElementById('reportModal');
    const reportPeriodDisplay = document.getElementById('reportPeriodDisplay');
    const reportFormatSelect = document.getElementById('reportFormatSelect');

    let periodText = '';
    if (currentFilter === 'custom' && customDateRange) {
        periodText = `Custom: ${formatDate(new Date(customDateRange.start))} - ${formatDate(new Date(customDateRange.end))}`;
    } else {
        const periods = {
            'daily': 'Today',
            'weekly': 'Last 7 Days',
            'monthly': 'Last 30 Days',
            'yearly': 'Current Year'
        };
        periodText = periods[currentFilter] || 'Current Period';
    }

    reportPeriodDisplay.value = periodText;
    
    // Set format from dropdown
    const selectedFormat = reportFormatSelect.value;
    const formatRadio = document.querySelector(`input[name="downloadFormat"][value="${selectedFormat}"]`);
    if (formatRadio) {
        formatRadio.checked = true;
    }

    reportModal.classList.add('show');
}

// Load Dashboard Data
async function loadDashboardData(filter, dateRange = null) {
    try {
        let url = `/admin/api/dashboard-data?filter=${filter}`;
        
        if (filter === 'custom' && dateRange) {
            url += `&startDate=${dateRange.start}&endDate=${dateRange.end}`;
        }

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
            updateStats(data.stats);
            updateChart(data.chartData, filter, dateRange);
            updateRecentOrders(data.recentOrders);
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showNotification('Failed to load dashboard data', 'error');
    }
}

// Update Statistics Cards
function updateStats(stats) {
    document.getElementById('totalRevenue').textContent = `₹${formatNumber(stats.totalRevenue)}`;
    document.getElementById('totalOrders').textContent = formatNumber(stats.totalOrders);
    document.getElementById('activeProducts').textContent = formatNumber(stats.activeProducts);
    document.getElementById('totalDiscounts').textContent = `₹${formatNumber(stats.totalDiscounts)}`;

    // Update change indicators
    if (stats.revenueChange !== undefined) {
        const revenueChange = document.getElementById('revenueChange');
        revenueChange.textContent = `${stats.revenueChange > 0 ? '+' : ''}${stats.revenueChange}%`;
        revenueChange.className = `stat-change ${stats.revenueChange >= 0 ? 'positive' : 'negative'}`;
    }

    if (stats.ordersChange !== undefined) {
        const ordersChange = document.getElementById('ordersChange');
        ordersChange.textContent = `${stats.ordersChange > 0 ? '+' : ''}${stats.ordersChange}%`;
        ordersChange.className = `stat-change ${stats.ordersChange >= 0 ? 'positive' : 'negative'}`;
    }
}

// Initialize Chart
function initializeChart() {
    const ctx = document.getElementById('ordersChart').getContext('2d');
    ordersChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Orders',
                data: [],
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#3498db',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Update Chart Data
function updateChart(chartData, filter, dateRange = null) {
    let periodText;
    
    if (filter === 'custom' && dateRange) {
        periodText = `${formatDate(new Date(dateRange.start))} - ${formatDate(new Date(dateRange.end))}`;
    } else {
        const periodTexts = {
            'daily': 'Last 24 Hours',
            'weekly': 'Last 7 Days',
            'monthly': 'Last 30 Days',
            'yearly': 'Last 12 Months'
        };
        periodText = periodTexts[filter] || 'Custom Period';
    }

    document.getElementById('chartPeriod').textContent = periodText;

    ordersChart.data.labels = chartData.labels;
    ordersChart.data.datasets[0].data = chartData.data;
    ordersChart.update();
}

// Update Recent Orders Table
function updateRecentOrders(orders) {
    const tbody = document.getElementById('recentOrdersBody');
    
    if (!orders || orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="loading-row">No orders found</td></tr>';
        return;
    }

    tbody.innerHTML = orders.map(order => `
        <tr>
            <td><strong>#${order.orderNumber || order._id.substring(0, 8)}</strong></td>
            <td>${formatDate(order.createdAt)}</td>
            <td>${order.userName || 'Guest User'}</td>
            <td><strong>₹${formatNumber(order.orderAmount)}</strong></td>
            <td><span class="status-badge status-${order.orderStatus.toLowerCase()}">${order.orderStatus}</span></td>
        </tr>
    `).join('');
}

// Generate Sales Report
async function generateSalesReport() {
    const selectedFormatRadio = document.querySelector('input[name="downloadFormat"]:checked');
    
    if (!selectedFormatRadio) {
        showNotification('Please select a format', 'error');
        return;
    }

    const selectedFormat = selectedFormatRadio.value;

    try {
        let params = new URLSearchParams({
            format: selectedFormat
        });

        if (currentFilter === 'custom' && customDateRange) {
            params.append('type', 'custom');
            params.append('startDate', customDateRange.start);
            params.append('endDate', customDateRange.end);
        } else {
            params.append('type', currentFilter);
        }

        const response = await fetch(`/admin/api/generate-report?${params.toString()}`);
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const extension = selectedFormat === 'excel' ? 'xlsx' : selectedFormat;
            const dateStr = new Date().toISOString().split('T')[0];
            a.download = `sales-report-${currentFilter}-${dateStr}.${extension}`;
            
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            document.getElementById('reportModal').classList.remove('show');
            showNotification('Report generated successfully!', 'success');
        } else {
            throw new Error('Failed to generate report');
        }
    } catch (error) {
        console.error('Error generating report:', error);
        showNotification('Failed to generate report', 'error');
    }
}

// Utility Functions
function formatNumber(num) {
    if (!num) return '0';
    return new Intl.NumberFormat('en-IN').format(num);
}

function formatDate(date) {
    return new Date(date).toLocaleDateString('en-IN', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
    });
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Add CSS animations for notifications
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

</script>

