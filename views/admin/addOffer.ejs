
<body>
      <%- include("../partials/admin/header") %> 

    <div class="add-offer-container">
        <div class="add-offer-header">
            <h1>Add Offer</h1>
            <p class="subtitle">Create a new offer for products or categories</p>
        </div>

        <div class="add-offer-card">
            <form id="addOfferForm">
                <div class="form-grid">
                    <!-- Offer Name -->
                    <div class="form-group">
                        <label for="offerName" class="form-label">
                            Offer Name <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="offerName" 
                            name="offerName" 
                            class="form-input" 
                            placeholder="e.g., Summer Sale"
                            required
                        >
                        <span class="error-message" id="offerNameError"></span>
                    </div>

                    <!-- Discount Percentage -->
                    <div class="form-group">
                        <label for="discount" class="form-label">
                            Discount Percentage <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <span class="input-icon">%</span>
                            <input 
                                type="number" 
                                id="discount" 
                                name="discount" 
                                class="form-input with-icon" 
                                placeholder="Enter percentage "
                                min="1"
                                max="99"
                                step="0.01"
                                required
                            >
                        </div>
                        <span class="error-message" id="discountError"></span>
                    </div>

                    <!-- Offer Type -->
                    <div class="form-group">
                        <label for="offerType" class="form-label">
                            Offer Type <span class="required">*</span>
                        </label>
                        <select id="offerType" name="offerType" class="form-select" required>
                            <option value="">Select Offer Type</option>
                            <option value="category">Category</option>
                            <option value="product">Product</option>
                        </select>
                        <span class="error-message" id="offerTypeError"></span>
                    </div>

                    <!-- Select Categories (Hidden initially) -->
                    <div class="form-group" id="categoryGroup" style="display: none;">
                        <label for="categories" class="form-label">
                            Select Categories <span class="required">*</span>
                        </label>
                        <select id="categories" name="categoryId" class="form-select" multiple size="5">
                            <% if (categories && categories.length > 0) { %>
                                <% categories.forEach(category => { %>
                                    <% if (category.isActive) { %>
                                        <option value="<%= category._id %>"><%= category.name %></option>
                                    <% } %>
                                <% }); %>
                            <% } else { %>
                                <option disabled>No categories available</option>
                            <% } %>
                        </select>
                        <small class="form-hint">Hold Ctrl (Cmd on Mac) to select multiple categories</small>
                        <span class="error-message" id="categoriesError"></span>
                    </div>

                    <!-- Select Products (Hidden initially) -->
                    <div class="form-group" id="productGroup" style="display: none;">
                        <label for="products" class="form-label">
                            Select Products <span class="required">*</span>
                        </label>
                        <select id="products" name="productId" class="form-select" multiple size="5">
                            <% if (products && products.length > 0) { %>
                                <% products.forEach(product => { %>
                                    <% if (!product.isBlocked && product.status === 'Available') { %>
                                        <option value="<%= product._id %>"><%= product.productName %></option>
                                    <% } %>
                                <% }); %>
                            <% } else { %>
                                <option disabled>No products available</option>
                            <% } %>
                        </select>
                        <small class="form-hint">Hold Ctrl (Cmd on Mac) to select multiple products</small>
                        <span class="error-message" id="productsError"></span>
                    </div>

                    <!-- Start Date -->
                    <div class="form-group">
                        <label for="startDate" class="form-label">
                            Start Date <span class="required">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="startDate" 
                            name="startDate" 
                            class="form-input" 
                            required
                        >
                        <span class="error-message" id="startDateError"></span>
                    </div>

                    <!-- End Date -->
                    <div class="form-group">
                        <label for="endDate" class="form-label">
                            End Date <span class="required">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="endDate" 
                            name="endDate" 
                            class="form-input" 
                            required
                        >
                        <span class="error-message" id="endDateError"></span>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-save">Add Offer</button>
                </div>
            </form>
        </div>
    </div>

    
    <script >
    
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('addOfferForm');
    const offerTypeSelect = document.getElementById('offerType');
    const categoryGroup = document.getElementById('categoryGroup');
    const productGroup = document.getElementById('productGroup');
    const categoriesSelect = document.getElementById('categories');
    const productsSelect = document.getElementById('products');
    const cancelBtn = document.getElementById('cancelBtn');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const offerNameInput = document.getElementById('offerName');
    const discountInput = document.getElementById('discount');

    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    startDateInput.setAttribute('min', today);
    endDateInput.setAttribute('min', today);

    // Handle offer type change
    offerTypeSelect.addEventListener('change', function() {
        const selectedType = this.value;
        
        // Hide both groups initially
        categoryGroup.style.display = 'none';
        productGroup.style.display = 'none';
        
        // Clear selections
        categoriesSelect.selectedIndex = -1;
        productsSelect.selectedIndex = -1;
        
        // Clear errors
        clearError('categories');
        clearError('products');
        clearError('offerType');
        
        // Show relevant group
        if (selectedType === 'category') {
            categoryGroup.style.display = 'block';
            categoriesSelect.required = true;
            productsSelect.required = false;
        } else if (selectedType === 'product') {
            productGroup.style.display = 'block';
            productsSelect.required = true;
            categoriesSelect.required = false;
        }
    });

    // Update end date minimum when start date changes
    startDateInput.addEventListener('change', function() {
        const startDate = this.value;
        if (startDate) {
            endDateInput.setAttribute('min', startDate);
            
            // If end date is before start date, clear it
            if (endDateInput.value && endDateInput.value < startDate) {
                endDateInput.value = '';
            }
        }
        clearError('startDate');
        
        // Revalidate end date if it exists
        if (endDateInput.value) {
            validateEndDate();
        }
    });

    endDateInput.addEventListener('change', function() {
        validateEndDate();
    });

    // Real-time validation for offer name
    offerNameInput.addEventListener('blur', function() {
        validateOfferName();
    });

    offerNameInput.addEventListener('input', function() {
        if (this.value.trim()) {
            clearError('offerName');
        }
    });

    // Real-time validation for discount
    discountInput.addEventListener('blur', function() {
        validateDiscount();
    });

    discountInput.addEventListener('input', function() {
        if (this.value) {
            clearError('discount');
        }
    });

    // Real-time validation for offer type
    offerTypeSelect.addEventListener('blur', function() {
        validateOfferType();
    });

    // Real-time validation for categories
    categoriesSelect.addEventListener('change', function() {
        if (this.selectedOptions.length > 0) {
            clearError('categories');
        } else {
            validateCategories();
        }
    });

    // Real-time validation for products
    productsSelect.addEventListener('change', function() {
        if (this.selectedOptions.length > 0) {
            clearError('products');
        } else {
            validateProducts();
        }
    });

    // Validation functions
    function validateOfferName() {
        const offerName = offerNameInput.value.trim();
        if (!offerName) {
            showError('offerName', 'Offer name is required');
            return false;
        } else if (offerName.length < 3) {
            showError('offerName', 'Offer name must be at least 3 characters');
            return false;
        } else if (offerName.length > 50) {
            showError('offerName', 'Offer name must not exceed 50 characters');
            return false;
        } else if (!/^[a-zA-Z0-9\s\-&]+$/.test(offerName)) {
            showError('offerName', 'Offer name can only contain letters, numbers, spaces, hyphens and &');
            return false;
        }
        clearError('offerName');
        return true;
    }

    function validateDiscount() {
        const discount = parseFloat(discountInput.value);
        if (!discountInput.value || isNaN(discount)) {
            showError('discount', 'Discount percentage is required');
            return false;
        } else if (discount < 1 || discount > 99) {
            showError('discount', 'Discount must be between 1% and 99%');
            return false;
        } else if (discount % 1 !== 0) {
            showError('discount', 'Discount must be a whole number');
            return false;
        }
        clearError('discount');
        return true;
    }

    function validateOfferType() {
        const offerType = offerTypeSelect.value;
        if (!offerType) {
            showError('offerType', 'Please select an offer type');
            return false;
        }
        clearError('offerType');
        return true;
    }

    function validateCategories() {
        const offerType = offerTypeSelect.value;
        if (offerType === 'category') {
            const selectedCategories = Array.from(categoriesSelect.selectedOptions).map(opt => opt.value);
            if (selectedCategories.length === 0) {
                showError('categories', 'Please select at least one category');
                return false;
            }
        }
        clearError('categories');
        return true;
    }

    function validateProducts() {
        const offerType = offerTypeSelect.value;
        if (offerType === 'product') {
            const selectedProducts = Array.from(productsSelect.selectedOptions).map(opt => opt.value);
            if (selectedProducts.length === 0) {
                showError('products', 'Please select at least one product');
                return false;
            }
        }
        clearError('products');
        return true;
    }

    function validateStartDate() {
        const startDate = startDateInput.value;
        if (!startDate) {
            showError('startDate', 'Start date is required');
            return false;
        }
        
        const startDateObj = new Date(startDate);
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0);
        
        if (startDateObj < todayDate) {
            showError('startDate', 'Start date must be today or in the future');
            return false;
        }
        
        clearError('startDate');
        return true;
    }

    function validateEndDate() {
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        
        if (!endDate) {
            showError('endDate', 'End date is required');
            return false;
        }
        
        if (startDate && endDate) {
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            
            if (endDateObj < startDateObj) {
                showError('endDate', 'End date must be after start date');
                return false;
            }
            
            if (endDateObj.getTime() === startDateObj.getTime()) {
                showError('endDate', 'End date must be different from start date');
                return false;
            }
        }
        
        clearError('endDate');
        return true;
    }

    // Form validation (comprehensive check before submission)
    function validateForm() {
        let isValid = true;

        // Clear all errors first
        clearAllErrors();

        // Validate all fields
        if (!validateOfferName()) isValid = false;
        if (!validateDiscount()) isValid = false;
        if (!validateOfferType()) isValid = false;
        
        const offerType = offerTypeSelect.value;
        if (offerType === 'category') {
            if (!validateCategories()) isValid = false;
        } else if (offerType === 'product') {
            if (!validateProducts()) isValid = false;
        }
        
        if (!validateStartDate()) isValid = false;
        if (!validateEndDate()) isValid = false;

        return isValid;
    }

    function showError(fieldId, message) {
        const errorElement = document.getElementById(fieldId + 'Error');
        const inputElement = document.getElementById(fieldId);
        
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.style.color = '#e74c3c';
            errorElement.style.fontSize = '0.875rem';
            errorElement.style.marginTop = '0.25rem';
            errorElement.style.display = 'block';
        }
        
        if (inputElement) {
            inputElement.style.borderColor = '#e74c3c';
        }
    }

    function clearError(fieldId) {
        const errorElement = document.getElementById(fieldId + 'Error');
        const inputElement = document.getElementById(fieldId);
        
        if (errorElement) {
            errorElement.textContent = '';
            errorElement.style.display = 'none';
        }
        
        if (inputElement) {
            inputElement.style.borderColor = '#dfe6e9';
        }
    }

    function clearAllErrors() {
        const errorElements = document.querySelectorAll('.error-message');
        errorElements.forEach(element => {
            element.textContent = '';
            element.style.display = 'none';
        });

        const inputs = document.querySelectorAll('.form-input, .form-select, .form-textarea');
        inputs.forEach(input => {
            input.style.borderColor = '#dfe6e9';
        });
    }

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!validateForm()) {
            Swal.fire({
                icon: 'error',
                title: 'Validation Error',
                text: 'Please fix all errors before submitting',
                confirmButtonColor: '#e74c3c'
            });
            return;
        }

        // Prepare form data
        const offerType = offerTypeSelect.value;
        const formData = {
            offerName: offerNameInput.value.trim(),
            discount: parseFloat(discountInput.value),
            offerType: offerType,
            startDate: startDateInput.value,
            endDate: endDateInput.value
        };

        // Add category or product IDs based on offer type
        if (offerType === 'category') {
            formData.categoryId = Array.from(categoriesSelect.selectedOptions).map(opt => opt.value);
        } else if (offerType === 'product') {
            formData.productId = Array.from(productsSelect.selectedOptions).map(opt => opt.value);
        }

        // Disable submit button
        const submitBtn = form.querySelector('.btn-save');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating...';

        try {
            const response = await fetch('/admin/offers/addOffer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (response.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Offer created successfully',
                    confirmButtonColor: '#27ae60'
                }).then(() => {
                    window.location.href = '/admin/offers';
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to create offer',
                    confirmButtonColor: '#e74c3c'
                });
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while creating the offer',
                confirmButtonColor: '#e74c3c'
            });
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add Offer';
        }
    });

    // Cancel button
    cancelBtn.addEventListener('click', function() {
        Swal.fire({
            title: 'Are you sure?',
            text: 'All unsaved changes will be lost',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e74c3c',
            cancelButtonColor: '#95a5a6',
            confirmButtonText: 'Yes, discard changes',
            cancelButtonText: 'Continue editing'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = '/admin/offers';
            }
        });
    });
});

    </script>
    
</body>
</html>